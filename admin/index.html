<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin Panel | WYATT XXX COLE</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .admin-container {
            min-height: 100vh;
            padding: var(--space-2xl);
        }

        /* Login Form */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: var(--bg-card);
            padding: var(--space-2xl);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(198, 142, 63, 0.2);
        }
        .login-container h1 {
            text-align: center;
            margin-bottom: var(--space-xl);
            font-size: 2rem;
        }
        .login-container .logo {
            text-align: center;
            margin-bottom: var(--space-xl);
        }
        .login-container .logo img {
            max-width: 150px;
            margin: 0 auto;
        }

        /* Dashboard */
        .dashboard { display: none; }
        .dashboard.active { display: block; }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-2xl);
            padding-bottom: var(--space-lg);
            border-bottom: 1px solid rgba(198, 142, 63, 0.2);
        }
        .dashboard-header h1 {
            font-size: 2rem;
        }

        .dashboard-nav {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-2xl);
            flex-wrap: wrap;
        }
        .dashboard-nav button {
            padding: var(--space-sm) var(--space-lg);
            background: var(--bg-card);
            border: 1px solid rgba(198, 142, 63, 0.2);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-family: var(--font-condensed);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-normal);
        }
        .dashboard-nav button:hover,
        .dashboard-nav button.active {
            background: var(--whiskey);
            color: var(--bg-primary);
            border-color: var(--whiskey);
        }

        /* Panels */
        .panel { display: none; }
        .panel.active { display: block; }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-xl);
            flex-wrap: wrap;
            gap: var(--space-md);
        }
        .panel-header h2 {
            font-size: 1.5rem;
        }

        /* Stats Grid */
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-2xl);
        }
        .admin-stat {
            background: var(--bg-card);
            padding: var(--space-lg);
            border-radius: var(--radius-md);
            border: 1px solid rgba(198, 142, 63, 0.1);
        }
        .admin-stat__value {
            font-family: var(--font-heading);
            font-size: 2.5rem;
            color: var(--whiskey);
            line-height: 1;
        }
        .admin-stat__label {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-top: var(--space-xs);
        }

        /* Table */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        .admin-table th,
        .admin-table td {
            padding: var(--space-md);
            text-align: left;
            border-bottom: 1px solid rgba(198, 142, 63, 0.1);
        }
        .admin-table th {
            background: var(--bg-secondary);
            font-family: var(--font-condensed);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--whiskey);
        }
        .admin-table tr:hover {
            background: rgba(198, 142, 63, 0.05);
        }
        .admin-table .status {
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .admin-table .status--pending {
            background: rgba(198, 142, 63, 0.2);
            color: var(--whiskey);
        }
        .admin-table .status--completed {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }
        .admin-table .status--cancelled {
            background: rgba(164, 74, 42, 0.2);
            color: var(--rust);
        }

        .action-btn {
            padding: var(--space-xs) var(--space-sm);
            background: var(--bg-secondary);
            border: 1px solid rgba(198, 142, 63, 0.2);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .action-btn:hover {
            background: var(--whiskey);
            color: var(--bg-primary);
        }
        .action-btn--danger:hover {
            background: var(--rust);
        }

        /* Settings Form */
        .settings-section {
            background: var(--bg-card);
            padding: var(--space-xl);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(198, 142, 63, 0.1);
            margin-bottom: var(--space-xl);
        }
        .settings-section h3 {
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid rgba(198, 142, 63, 0.1);
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed rgba(198, 142, 63, 0.3);
            border-radius: var(--radius-lg);
            padding: var(--space-2xl);
            text-align: center;
            cursor: pointer;
            transition: var(--transition-normal);
            position: relative;
        }
        .upload-area:hover {
            border-color: var(--whiskey);
            background: rgba(198, 142, 63, 0.05);
        }
        .upload-area.dragging {
            border-color: var(--whiskey);
            background: rgba(198, 142, 63, 0.1);
        }
        .upload-area svg {
            width: 48px;
            height: 48px;
            stroke: var(--whiskey);
            margin-bottom: var(--space-md);
        }
        .upload-area input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        .upload-preview {
            max-width: 300px;
            margin-top: var(--space-md);
        }
        .upload-preview img {
            width: 100%;
            border-radius: var(--radius-md);
        }

        /* Gallery Management */
        .gallery-grid-admin {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--space-md);
        }
        .gallery-item-admin {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-md);
            overflow: hidden;
            background: var(--bg-card);
        }
        .gallery-item-admin img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .gallery-item-admin .delete-btn {
            position: absolute;
            top: var(--space-xs);
            right: var(--space-xs);
            width: 28px;
            height: 28px;
            background: var(--rust);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            opacity: 0;
            transition: var(--transition-fast);
        }
        .gallery-item-admin:hover .delete-btn {
            opacity: 1;
        }
        .gallery-item-admin .delete-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        /* Upload progress */
        .upload-progress {
            margin-top: var(--space-md);
        }
        .progress-bar {
            height: 4px;
            background: var(--bg-secondary);
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-bar__fill {
            height: 100%;
            background: var(--whiskey);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Notifications */
        .notification {
            position: fixed;
            bottom: var(--space-xl);
            right: var(--space-xl);
            padding: var(--space-md) var(--space-xl);
            border-radius: var(--radius-md);
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        .notification--success {
            background: #4CAF50;
        }
        .notification--error {
            background: var(--rust);
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: var(--space-3xl);
            color: var(--text-muted);
        }
        .empty-state svg {
            width: 64px;
            height: 64px;
            stroke: var(--text-muted);
            margin-bottom: var(--space-md);
        }

        /* Pricing Management */
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-lg);
        }
        .pricing-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            border: 1px solid rgba(198, 142, 63, 0.2);
        }
        .pricing-card__header {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid rgba(198, 142, 63, 0.1);
        }
        .pricing-card__icon {
            font-size: 2rem;
        }
        .pricing-card__title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .pricing-card__subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .pricing-input-group {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }
        .pricing-input-group label {
            flex: 1;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .pricing-input-group input {
            width: 100px;
            padding: var(--space-sm);
            background: var(--bg-card);
            border: 1px solid rgba(198, 142, 63, 0.3);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            text-align: right;
            font-size: 1rem;
        }
        .pricing-input-group .currency {
            color: var(--whiskey);
            font-weight: 600;
        }
        .pricing-features {
            margin-top: var(--space-md);
        }
        .pricing-features h5 {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: var(--space-sm);
        }
        .pricing-features textarea {
            width: 100%;
            min-height: 80px;
            padding: var(--space-sm);
            background: var(--bg-card);
            border: 1px solid rgba(198, 142, 63, 0.2);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.85rem;
            resize: vertical;
        }
        .pricing-badge {
            display: inline-block;
            padding: 2px 8px;
            background: var(--whiskey);
            color: var(--bg-primary);
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: var(--space-sm);
        }
        .pricing-toggle {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }
        .pricing-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        .pricing-section-tabs {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-xl);
        }
        .pricing-section-tabs button {
            padding: var(--space-sm) var(--space-lg);
            background: var(--bg-secondary);
            border: 1px solid rgba(198, 142, 63, 0.2);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-normal);
        }
        .pricing-section-tabs button.active {
            background: var(--whiskey);
            color: var(--bg-primary);
            border-color: var(--whiskey);
        }
        .pricing-subsection {
            display: none;
        }
        .pricing-subsection.active {
            display: block;
        }
        .pricing-actions {
            display: flex;
            gap: var(--space-md);
            margin-top: var(--space-xl);
            padding-top: var(--space-lg);
            border-top: 1px solid rgba(198, 142, 63, 0.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-container {
                padding: var(--space-md);
            }
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-md);
            }
            .dashboard-nav {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: var(--space-sm);
            }
        }

        /* Tier select dropdowns */
        .tier-select {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid rgba(198, 142, 63, 0.3);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
        }
        .tier-select.tier-admin {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
            border-color: #dc2626;
        }
        .tier-select.tier-vip {
            background: linear-gradient(135deg, var(--whiskey), var(--rust));
            color: white;
            border-color: var(--whiskey);
        }
        .tier-select.tier-free {
            background: var(--bg-secondary);
        }

        /* Integration Tabs */
        .integration-tabs {
            display: flex;
            gap: var(--space-xs);
            background: var(--bg-card);
            padding: var(--space-xs);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-xl);
            flex-wrap: wrap;
        }
        .int-tab {
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-sm);
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-weight: 500;
            transition: all 0.2s;
        }
        .int-tab:hover { color: var(--text-primary); }
        .int-tab.active {
            background: var(--whiskey);
            color: var(--bg-primary);
        }
        .int-tab-content { display: none; }
        .int-tab-content.active { display: block; }

        /* Vendor Grid */
        .vendor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--space-lg);
        }
        .vendor-card {
            background: var(--bg-card);
            border: 1px solid rgba(198, 142, 63, 0.15);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
        }
        .vendor-card:hover {
            border-color: var(--whiskey);
        }
        .vendor-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
        }
        .vendor-name {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .vendor-type {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .vendor-fields {
            margin-bottom: var(--space-md);
        }
        .vendor-actions {
            display: flex;
            gap: var(--space-sm);
        }
        .status-badge.connected {
            background: rgba(0, 204, 102, 0.2);
            color: #00cc66;
        }
        .status-badge.disconnected {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        .status-pending {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }
        .status-banned {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Health indicators */
        .health-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }
        .health-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #888;
        }
        .health-dot.healthy {
            background: #22c55e;
            box-shadow: 0 0 6px #22c55e;
        }
        .health-dot.warning {
            background: #eab308;
            box-shadow: 0 0 6px #eab308;
        }
        .health-dot.error {
            background: #ef4444;
            box-shadow: 0 0 6px #ef4444;
        }

        /* Analytics Dashboard Styles */
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        .stat-comparison {
            font-size: 0.75rem;
            margin-top: var(--space-xs);
        }
        .stat-comparison.positive {
            color: #4ade80;
        }
        .stat-comparison.negative {
            color: #ef4444;
        }
        .progress-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--whiskey);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .realtime-visitor-pill {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        .realtime-visitor-pill .page {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            vertical-align: bottom;
        }
        #trafficChartSvg text {
            fill: var(--text-muted);
            font-size: 10px;
        }
        #trafficChartSvg .grid-line {
            stroke: rgba(255,255,255,0.05);
            stroke-dasharray: 3,3;
        }
        #trafficChartSvg .chart-line {
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        #trafficChartSvg .chart-area {
            opacity: 0.15;
        }
        #trafficChartSvg .data-point {
            cursor: pointer;
        }
        #trafficChartSvg .data-point:hover {
            r: 6;
        }
        .chart-tooltip {
            position: absolute;
            background: var(--bg-card);
            border: 1px solid rgba(198,142,63,0.3);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.8rem;
            pointer-events: none;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .breakdown-bar {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
        }
        .breakdown-bar .label {
            width: 80px;
            font-size: 0.85rem;
        }
        .breakdown-bar .count {
            font-size: 0.85rem;
            color: var(--text-muted);
            min-width: 40px;
            text-align: right;
        }

        /* Request modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid rgba(198, 142, 63, 0.2);
        }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }
        .modal-close:hover {
            color: var(--text-primary);
        }

        /* Analytics bar */
        .analytics-bar {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-sm) 0;
        }
        .analytics-bar__label {
            width: 120px;
            font-weight: 500;
        }
        .analytics-bar__track {
            flex: 1;
            height: 24px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }
        .analytics-bar__fill {
            height: 100%;
            background: linear-gradient(90deg, var(--whiskey), var(--rust));
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: var(--space-sm);
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }
        .analytics-bar__count {
            width: 60px;
            text-align: right;
            font-weight: 600;
        }

        /* Table container */
        .table-container {
            overflow-x: auto;
        }

        /* Theme Editor Styles */
        .color-control label,
        .typography-control label,
        .background-control label,
        .effect-control label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-xs);
            font-weight: 500;
        }
        .color-input-wrapper {
            display: flex;
            gap: var(--space-sm);
            align-items: center;
        }
        .color-input-wrapper input[type="color"] {
            width: 50px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            padding: 0;
            background: transparent;
        }
        .color-input-wrapper input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 2px;
        }
        .color-input-wrapper input[type="color"]::-webkit-color-swatch {
            border-radius: 6px;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .color-hex {
            flex: 1;
            padding: var(--space-sm);
            background: var(--surface);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: monospace;
            font-size: 0.9rem;
        }
        .typography-control select,
        .background-control select,
        .effect-control select,
        .background-control input[type="text"] {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            background: var(--surface);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        .range-with-value {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        .range-with-value input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            background: var(--surface);
            border-radius: 3px;
        }
        .range-with-value input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--whiskey);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
        }
        .range-with-value span {
            min-width: 50px;
            text-align: right;
            font-family: monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .toggle-wrapper {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        .toggle-wrapper input[type="checkbox"] {
            width: 44px;
            height: 24px;
            -webkit-appearance: none;
            background: var(--surface);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-wrapper input[type="checkbox"]::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        .toggle-wrapper input[type="checkbox"]:checked {
            background: var(--whiskey);
        }
        .toggle-wrapper input[type="checkbox"]:checked::after {
            transform: translateX(20px);
        }
        .toggle-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .theme-preset-card {
            background: var(--card-bg);
            border: 2px solid var(--border-subtle);
            border-radius: 12px;
            padding: var(--space-md);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        .theme-preset-card:hover {
            border-color: var(--whiskey);
            transform: translateY(-2px);
        }
        .theme-preset-card.active {
            border-color: var(--whiskey);
            box-shadow: 0 0 20px rgba(193,154,107,0.3);
        }
        .theme-preset-card .preset-colors {
            display: flex;
            gap: 4px;
            justify-content: center;
            margin-bottom: var(--space-sm);
        }
        .theme-preset-card .preset-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .theme-preset-card .preset-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        .theme-preset-card .preset-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .effect-preview-card {
            transition: all 0.3s ease;
        }
        .effect-preview-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }
        .btn--danger {
            background: transparent;
            border: 1px solid var(--rust);
            color: var(--rust);
        }
        .btn--danger:hover {
            background: var(--rust);
            color: white;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Login Form -->
        <div class="login-container" id="loginForm">
            <div class="logo">
                <img src="images/logo.png" alt="WXXXC" onerror="this.style.display='none'">
            </div>
            <h1>Admin Login</h1>
            <form id="adminLoginForm">
                <div class="form__group">
                    <label class="form__label" for="username">Username</label>
                    <input type="text" id="username" name="username" class="form__input" required>
                </div>
                <div class="form__group">
                    <label class="form__label" for="password">Password</label>
                    <input type="password" id="password" name="password" class="form__input" required>
                </div>
                <button type="submit" class="btn btn--primary" style="width: 100%;">Login</button>
            </form>

            <!-- Verification Form (hidden by default) -->
            <div id="verifyForm" style="display: none;">
                <div style="text-align: center; margin-bottom: var(--space-lg);">
                    <div style="font-size: 3rem; margin-bottom: var(--space-md);">üîê</div>
                    <h2 style="margin-bottom: var(--space-sm);">Verify Your Identity</h2>
                    <p style="color: var(--text-muted); font-size: 0.9rem;">
                        We sent a 6-digit code to your admin email.<br>Enter it below to continue.
                    </p>
                </div>
                <div class="form__group">
                    <label class="form__label" for="verifyCode">Verification Code</label>
                    <input type="text" id="verifyCode" class="form__input" maxlength="6" placeholder="000000"
                           style="text-align: center; font-size: 1.5rem; letter-spacing: 0.5em;" required>
                </div>
                <button type="button" id="verifyBtn" class="btn btn--primary" style="width: 100%;">Verify</button>
                <button type="button" id="backToLogin" class="btn btn--secondary" style="width: 100%; margin-top: var(--space-sm);">Back to Login</button>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="dashboard" id="dashboard">
            <div class="dashboard-header">
                <h1><span class="gradient-text">WXXXC</span> Admin</h1>
                <button class="btn btn--secondary" onclick="logout()">Logout</button>
            </div>

            <nav class="dashboard-nav">
                <button class="active" data-panel="overview">Dashboard</button>
                <button data-panel="requests">Requests</button>
                <button data-panel="subscribers">Subscribers</button>
                <button data-panel="featured">Featured</button>
                <button data-panel="media">Media</button>
                <button data-panel="gallery">Gallery</button>
                <button data-panel="theme">Theme Editor</button>
                <button data-panel="analytics">Analytics</button>
                <button data-panel="integrations">Integrations</button>
                <button data-panel="settings">Settings</button>
                <button data-panel="security">Security</button>
            </nav>

            <!-- Overview/Dashboard Panel -->
            <div class="panel active" id="panel-overview">
                <div class="admin-stats">
                    <div class="admin-stat">
                        <div class="admin-stat__value" id="stat-subscribers">0</div>
                        <div class="admin-stat__label">Email Subscribers</div>
                    </div>
                    <div class="admin-stat">
                        <div class="admin-stat__value" id="stat-requests-new">0</div>
                        <div class="admin-stat__label">New Requests (7d)</div>
                    </div>
                    <div class="admin-stat">
                        <div class="admin-stat__value" id="stat-requests-total">0</div>
                        <div class="admin-stat__label">Total Requests</div>
                    </div>
                    <div class="admin-stat">
                        <div class="admin-stat__value" id="stat-clicks">0</div>
                        <div class="admin-stat__label">Platform Clicks (7d)</div>
                    </div>
                </div>

                <!-- System Health -->
                <div class="settings-section" style="margin-bottom: var(--space-xl);">
                    <h3>System Health</h3>
                    <div id="systemHealth" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-md);">
                        <div class="health-item"><span class="health-dot" id="health-db"></span> Database</div>
                        <div class="health-item"><span class="health-dot" id="health-uploads"></span> File Uploads</div>
                        <div class="health-item"><span class="health-dot" id="health-smtp"></span> SMTP Email</div>
                    </div>
                </div>

                <!-- Last Login Info -->
                <div class="settings-section" id="lastLoginInfo" style="display: none;">
                    <h3>Last Login</h3>
                    <p id="lastLoginDetails" style="color: var(--text-secondary);"></p>
                </div>

                <h3>Quick Actions</h3>
                <div style="display: flex; gap: var(--space-md); flex-wrap: wrap; margin-bottom: var(--space-2xl);">
                    <button class="btn btn--primary" onclick="switchPanel('requests')">View Requests</button>
                    <button class="btn btn--secondary" onclick="switchPanel('subscribers')">Subscribers</button>
                    <button class="btn btn--secondary" onclick="switchPanel('media')">Upload Media</button>
                    <button class="btn btn--secondary" onclick="switchPanel('settings')">Settings</button>
                </div>
            </div>

            <!-- Featured Carousel Panel -->
            <div class="panel" id="panel-featured">
                <div class="panel-header">
                    <h2>Featured Carousel</h2>
                    <button class="btn btn--primary" onclick="document.getElementById('featuredUpload').click()">
                        + Add Photo
                    </button>
                    <input type="file" id="featuredUpload" accept="image/*" style="display: none;">
                </div>

                <div class="settings-section">
                    <h3>Upload Featured Photo</h3>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-md);">
                        Featured photos appear in the carousel at the top of the homepage. Recommended: High quality images, 1920x1080 or larger.
                    </p>
                    <div class="upload-area" id="featuredDropzone">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <p>Click or drag to upload featured photo</p>
                        <input type="file" id="featuredBulkUpload" accept="image/*">
                    </div>
                    <div style="margin-top: var(--space-lg); display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md);">
                        <div class="form__group">
                            <label class="form__label">Title</label>
                            <input type="text" id="featuredTitle" class="form__input" placeholder="e.g., New Exclusive Content">
                        </div>
                        <div class="form__group">
                            <label class="form__label">Caption</label>
                            <input type="text" id="featuredCaption" class="form__input" placeholder="e.g., Check out my latest shoot">
                        </div>
                        <div class="form__group">
                            <label class="form__label">Link URL</label>
                            <input type="text" id="featuredLink" class="form__input" placeholder="e.g., gallery.html or https://...">
                        </div>
                        <div class="form__group">
                            <label class="form__label">Link Button Text</label>
                            <input type="text" id="featuredLinkText" class="form__input" placeholder="e.g., View Gallery">
                        </div>
                        <div class="form__group" style="grid-column: 1 / -1;">
                            <label class="form__label">Alt Text (for accessibility)</label>
                            <input type="text" id="featuredAltText" class="form__input" placeholder="Describe the image for screen readers">
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Current Featured Photos (<span id="featuredCount">0</span>)</h3>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-md);">
                        Drag to reorder. Photos appear in the carousel in this order.
                    </p>
                    <div class="gallery-grid-admin" id="featuredAdmin" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));">
                        <!-- Featured images will be loaded here -->
                    </div>
                    <div class="empty-state" id="featuredEmpty" style="display: none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                        </svg>
                        <p>No featured photos yet</p>
                        <p>Upload photos to show in the homepage carousel!</p>
                    </div>
                    <div style="margin-top: var(--space-lg);">
                        <button class="btn btn--primary" onclick="saveFeaturedOrder()">Save Order</button>
                    </div>
                </div>
            </div>

            <!-- Media Panel (Logo & Hero) -->
            <div class="panel" id="panel-media">
                <div class="panel-header">
                    <h2>Media Management</h2>
                </div>

                <div class="settings-section">
                    <h3>Site Logo</h3>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-md);">
                        Upload your logo image. Recommended: PNG with transparent background, at least 500px wide.
                    </p>
                    <div class="upload-area" id="logoDropzone">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <p>Click or drag to upload logo</p>
                        <input type="file" id="logoUpload" accept="image/*">
                    </div>
                    <div class="upload-preview" id="logoPreview">
                        <img src="images/logo.png" alt="Current Logo" onerror="this.parentElement.style.display='none'">
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Hero Background</h3>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-md);">
                        Upload a hero/banner image. Recommended: 1920x1080 or larger, JPG or PNG.
                    </p>
                    <div class="upload-area" id="heroDropzone">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <p>Click or drag to upload hero image</p>
                        <input type="file" id="heroUpload" accept="image/*">
                    </div>
                    <div class="upload-preview" id="heroPreview"></div>
                </div>
            </div>

            <!-- Gallery Panel -->
            <div class="panel" id="panel-gallery">
                <div class="panel-header">
                    <h2>Gallery Management</h2>
                    <div>
                        <button class="btn btn--primary" onclick="document.getElementById('galleryUpload').click()">
                            + Add Images
                        </button>
                        <input type="file" id="galleryUpload" multiple accept="image/*" style="display: none;">
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Upload Multiple Images</h3>
                    <div class="upload-area" id="galleryDropzone">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                        </svg>
                        <p>Click or drag multiple images to upload</p>
                        <input type="file" id="galleryBulkUpload" multiple accept="image/*">
                    </div>
                    <div class="upload-progress" id="galleryProgress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-bar__fill" id="progressFill"></div>
                        </div>
                        <p style="margin-top: var(--space-sm); color: var(--text-secondary);" id="progressText">Uploading...</p>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Current Gallery (<span id="galleryCount">0</span> images)</h3>
                    <div class="gallery-grid-admin" id="galleryAdmin">
                        <!-- Gallery images will be loaded here -->
                    </div>
                    <div class="empty-state" id="galleryEmpty" style="display: none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                        </svg>
                        <p>No gallery images yet</p>
                        <p>Upload some images to get started!</p>
                    </div>
                </div>
            </div>

            <!-- Users Panel -->
            <div class="panel" id="panel-users">
                <div class="panel-header">
                    <h2>User Management</h2>
                    <button class="btn btn--secondary" onclick="loadUsers()">Refresh</button>
                </div>

                <div class="admin-stats" style="margin-bottom: var(--space-xl);">
                    <div class="admin-stat">
                        <div class="admin-stat__value" id="stat-total-users">0</div>
                        <div class="admin-stat__label">Total Users</div>
                    </div>
                    <div class="admin-stat">
                        <div class="admin-stat__value" id="stat-active-users">0</div>
                        <div class="admin-stat__label">Active Users</div>
                    </div>
                    <div class="admin-stat">
                        <div class="admin-stat__value" id="stat-pending-users">0</div>
                        <div class="admin-stat__label">Pending Verification</div>
                    </div>
                    <div class="admin-stat">
                        <div class="admin-stat__value" id="stat-banned-users">0</div>
                        <div class="admin-stat__label">Banned</div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>World Users</h3>
                    <div style="overflow-x: auto;">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Tier</th>
                                    <th>Status</th>
                                    <th>Verified</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <tr>
                                    <td colspan="7" style="text-align: center; color: var(--text-muted);">Loading users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pricing Panel -->
            <div class="panel" id="panel-pricing">
                <div class="panel-header">
                    <h2>Pricing Management</h2>
                </div>

                <div class="pricing-section-tabs">
                    <button class="active" onclick="switchPricingTab('booking')">Booking Services</button>
                    <button onclick="switchPricingTab('subscriptions')">Subscription Tiers</button>
                </div>

                <!-- Booking Prices -->
                <div class="pricing-subsection active" id="pricing-booking">
                    <div class="settings-section">
                        <h3>Booking Service Prices</h3>
                        <p style="color: var(--text-secondary); margin-bottom: var(--space-lg);">
                            Set prices for each booking service. Changes will update the booking page automatically.
                        </p>

                        <div class="pricing-grid" id="bookingPricingGrid">
                            <!-- Custom Videos -->
                            <div class="pricing-card" data-service="customVideos">
                                <div class="pricing-card__header">
                                    <span class="pricing-card__icon">üé¨</span>
                                    <div>
                                        <div class="pricing-card__title">Custom Videos</div>
                                        <div class="pricing-card__subtitle">Personalized content</div>
                                    </div>
                                </div>
                                <div class="pricing-input-group">
                                    <label>Base Price</label>
                                    <span class="currency">$</span>
                                    <input type="number" id="price-customVideos" value="50" min="0" step="5">
                                </div>
                                <div class="pricing-input-group">
                                    <label>Price Label</label>
                                    <input type="text" id="label-customVideos" value="Starting at" style="width: 150px; text-align: left;">
                                </div>
                            </div>

                            <!-- Live Sessions -->
                            <div class="pricing-card" data-service="liveSessions">
                                <div class="pricing-card__header">
                                    <span class="pricing-card__icon">üìπ</span>
                                    <div>
                                        <div class="pricing-card__title">Live Sessions</div>
                                        <div class="pricing-card__subtitle">One-on-one video calls</div>
                                    </div>
                                </div>
                                <div class="pricing-input-group">
                                    <label>Price per 30 min</label>
                                    <span class="currency">$</span>
                                    <input type="number" id="price-liveSessions" value="100" min="0" step="10">
                                </div>
                                <div class="pricing-input-group">
                                    <label>Price Label</label>
                                    <input type="text" id="label-liveSessions" value="Per 30 min" style="width: 150px; text-align: left;">
                                </div>
                            </div>

                            <!-- Ratings -->
                            <div class="pricing-card" data-service="ratings">
                                <div class="pricing-card__header">
                                    <span class="pricing-card__icon">‚≠ê</span>
                                    <div>
                                        <div class="pricing-card__title">Ratings</div>
                                        <div class="pricing-card__subtitle">Honest feedback</div>
                                    </div>
                                </div>
                                <div class="pricing-input-group">
                                    <label>Base Price</label>
                                    <span class="currency">$</span>
                                    <input type="number" id="price-ratings" value="25" min="0" step="5">
                                </div>
                                <div class="pricing-input-group">
                                    <label>Price Label</label>
                                    <input type="text" id="label-ratings" value="Starting at" style="width: 150px; text-align: left;">
                                </div>
                            </div>

                            <!-- Sexting -->
                            <div class="pricing-card" data-service="sexting">
                                <div class="pricing-card__header">
                                    <span class="pricing-card__icon">üí¨</span>
                                    <div>
                                        <div class="pricing-card__title">Sexting Sessions</div>
                                        <div class="pricing-card__subtitle">Live text chat</div>
                                    </div>
                                </div>
                                <div class="pricing-input-group">
                                    <label>Price per 30 min</label>
                                    <span class="currency">$</span>
                                    <input type="number" id="price-sexting" value="30" min="0" step="5">
                                </div>
                                <div class="pricing-input-group">
                                    <label>Price Label</label>
                                    <input type="text" id="label-sexting" value="Per 30 min" style="width: 150px; text-align: left;">
                                </div>
                            </div>
                        </div>

                        <div class="pricing-actions">
                            <button class="btn btn--primary" onclick="saveBookingPrices()">Save Booking Prices</button>
                            <button class="btn btn--secondary" onclick="resetBookingPrices()">Reset to Defaults</button>
                        </div>
                    </div>
                </div>

                <!-- Subscription Tiers -->
                <div class="pricing-subsection" id="pricing-subscriptions">
                    <div class="settings-section">
                        <h3>Subscription Tier Prices</h3>
                        <p style="color: var(--text-secondary); margin-bottom: var(--space-lg);">
                            Manage subscription tiers and their pricing. Changes will update the subscribe page automatically.
                        </p>

                        <div class="pricing-grid" id="subscriptionPricingGrid">
                            <!-- Free Tier -->
                            <div class="pricing-card" data-tier="free">
                                <div class="pricing-card__header">
                                    <span class="pricing-card__icon">ü§†</span>
                                    <div>
                                        <div class="pricing-card__title">Ranch Hand</div>
                                        <div class="pricing-card__subtitle">Free tier</div>
                                    </div>
                                </div>
                                <div class="pricing-input-group">
                                    <label>Price</label>
                                    <span class="currency">$</span>
                                    <input type="number" value="0" disabled style="opacity: 0.5;">
                                </div>
                                <div class="pricing-input-group">
                                    <label>Tagline</label>
                                    <input type="text" id="tagline-free" value="Just gettin' started" style="width: 180px; text-align: left;">
                                </div>
                            </div>

                            <!-- Silver Tier -->
                            <div class="pricing-card" data-tier="silver">
                                <div class="pricing-card__header">
                                    <span class="pricing-card__icon">‚≠ê</span>
                                    <div>
                                        <div class="pricing-card__title">Silver Spur</div>
                                        <div class="pricing-card__subtitle">Basic paid tier</div>
                                    </div>
                                </div>
                                <div class="pricing-input-group">
                                    <label>Monthly Price</label>
                                    <span class="currency">$</span>
                                    <input type="number" id="price-silver" value="9.99" min="0" step="0.99">
                                </div>
                                <div class="pricing-input-group">
                                    <label>Tagline</label>
                                    <input type="text" id="tagline-silver" value="For the dedicated fans" style="width: 180px; text-align: left;">
                                </div>
                            </div>

                            <!-- Gold Tier -->
                            <div class="pricing-card" data-tier="gold">
                                <div class="pricing-card__header">
                                    <span class="pricing-card__icon">üèÜ</span>
                                    <div>
                                        <div class="pricing-card__title">Gold Buckle</div>
                                        <div class="pricing-card__subtitle">Most popular<span class="pricing-badge">Featured</span></div>
                                    </div>
                                </div>
                                <div class="pricing-input-group">
                                    <label>Monthly Price</label>
                                    <span class="currency">$</span>
                                    <input type="number" id="price-gold" value="24.99" min="0" step="0.99">
                                </div>
                                <div class="pricing-input-group">
                                    <label>Booking Discount</label>
                                    <input type="number" id="discount-gold" value="10" min="0" max="50" style="width: 80px;">
                                    <span>%</span>
                                </div>
                                <div class="pricing-input-group">
                                    <label>Tagline</label>
                                    <input type="text" id="tagline-gold" value="The real deal" style="width: 180px; text-align: left;">
                                </div>
                            </div>

                            <!-- VIP Tier -->
                            <div class="pricing-card" data-tier="vip">
                                <div class="pricing-card__header">
                                    <span class="pricing-card__icon">üëë</span>
                                    <div>
                                        <div class="pricing-card__title">VIP Cowboy</div>
                                        <div class="pricing-card__subtitle">Elite tier<span class="pricing-badge">Elite</span></div>
                                    </div>
                                </div>
                                <div class="pricing-input-group">
                                    <label>Monthly Price</label>
                                    <span class="currency">$</span>
                                    <input type="number" id="price-vip" value="49.99" min="0" step="0.99">
                                </div>
                                <div class="pricing-input-group">
                                    <label>Booking Discount</label>
                                    <input type="number" id="discount-vip" value="25" min="0" max="50" style="width: 80px;">
                                    <span>%</span>
                                </div>
                                <div class="pricing-input-group">
                                    <label>Tagline</label>
                                    <input type="text" id="tagline-vip" value="Top of the herd" style="width: 180px; text-align: left;">
                                </div>
                            </div>
                        </div>

                        <div class="pricing-actions">
                            <button class="btn btn--primary" onclick="saveSubscriptionPrices()">Save Subscription Prices</button>
                            <button class="btn btn--secondary" onclick="resetSubscriptionPrices()">Reset to Defaults</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bookings Panel -->
            <div class="panel" id="panel-bookings">
                <div class="panel-header">
                    <h2>Booking Requests</h2>
                </div>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Name</th>
                            <th>Service</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bookingsTable">
                        <tr>
                            <td colspan="6" style="text-align: center; color: var(--text-muted);">No bookings yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Messages Panel -->
            <div class="panel" id="panel-messages">
                <div class="panel-header">
                    <h2>Messages</h2>
                </div>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>From</th>
                            <th>Subject</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="messagesTable">
                        <tr>
                            <td colspan="5" style="text-align: center; color: var(--text-muted);">No messages yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- World Users Panel -->
            <div class="panel" id="panel-world-users">
                <div class="panel-header">
                    <h2>Wyatt World Users</h2>
                    <button class="btn btn--primary" onclick="loadWorldUsers()">Refresh</button>
                </div>

                <div class="admin-stats" id="worldUserStats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalWorldUsers">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="adminUsers">0</div>
                        <div class="stat-label">Admins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUsers">0</div>
                        <div class="stat-label">Active</div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Tier</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="worldUsersTable">
                            <tr><td colspan="6" style="text-align: center; padding: 2rem;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Integrations Panel -->
            <div class="panel" id="panel-integrations">
                <div class="panel-header">
                    <h2>API & Integrations</h2>
                    <button class="btn btn--primary" onclick="saveAllIntegrations()">Save All Changes</button>
                </div>

                <!-- Integration Tabs -->
                <div class="integration-tabs">
                    <button class="int-tab active" onclick="showIntTab('pod')">POD Vendors</button>
                    <button class="int-tab" onclick="showIntTab('dropship')">Dropshipping</button>
                    <button class="int-tab" onclick="showIntTab('shipping')">Shipping</button>
                    <button class="int-tab" onclick="showIntTab('payments')">Payments</button>
                    <button class="int-tab" onclick="showIntTab('crypto')">Crypto</button>
                </div>

                <!-- POD Tab -->
                <div id="int-tab-pod" class="int-tab-content active">
                    <div class="vendor-grid">
                        <!-- Printful -->
                        <div class="vendor-card">
                            <div class="vendor-header">
                                <div>
                                    <div class="vendor-name">Printful</div>
                                    <div class="vendor-type">Print on Demand</div>
                                </div>
                                <span class="status-badge disconnected" id="status-printful">Not Connected</span>
                            </div>
                            <div class="vendor-fields">
                                <div class="form__group">
                                    <label class="form__label">API Key</label>
                                    <input type="password" id="printful-api-key" class="form__input" placeholder="Enter Printful API Key">
                                </div>
                            </div>
                            <div class="vendor-actions">
                                <button class="btn btn--outline btn--sm" onclick="testIntegration('printful')">Test</button>
                                <button class="btn btn--primary btn--sm" onclick="saveIntegration('printful')">Save</button>
                            </div>
                        </div>

                        <!-- Printify -->
                        <div class="vendor-card">
                            <div class="vendor-header">
                                <div>
                                    <div class="vendor-name">Printify</div>
                                    <div class="vendor-type">POD Network</div>
                                </div>
                                <span class="status-badge disconnected" id="status-printify">Not Connected</span>
                            </div>
                            <div class="vendor-fields">
                                <div class="form__group">
                                    <label class="form__label">API Key</label>
                                    <input type="password" id="printify-api-key" class="form__input" placeholder="Enter Printify API Key">
                                </div>
                                <div class="form__group">
                                    <label class="form__label">Shop ID</label>
                                    <input type="text" id="printify-shop-id" class="form__input" placeholder="Your Shop ID">
                                </div>
                            </div>
                            <div class="vendor-actions">
                                <button class="btn btn--outline btn--sm" onclick="testIntegration('printify')">Test</button>
                                <button class="btn btn--primary btn--sm" onclick="saveIntegration('printify')">Save</button>
                            </div>
                        </div>

                        <!-- Gooten -->
                        <div class="vendor-card">
                            <div class="vendor-header">
                                <div>
                                    <div class="vendor-name">Gooten</div>
                                    <div class="vendor-type">Global POD</div>
                                </div>
                                <span class="status-badge disconnected" id="status-gooten">Not Connected</span>
                            </div>
                            <div class="vendor-fields">
                                <div class="form__group">
                                    <label class="form__label">API Key</label>
                                    <input type="password" id="gooten-api-key" class="form__input" placeholder="Enter Gooten API Key">
                                </div>
                                <div class="form__group">
                                    <label class="form__label">Recipe ID</label>
                                    <input type="text" id="gooten-recipe-id" class="form__input" placeholder="Recipe ID">
                                </div>
                            </div>
                            <div class="vendor-actions">
                                <button class="btn btn--outline btn--sm" onclick="testIntegration('gooten')">Test</button>
                                <button class="btn btn--primary btn--sm" onclick="saveIntegration('gooten')">Save</button>
                            </div>
                        </div>

                        <!-- Gelato -->
                        <div class="vendor-card">
                            <div class="vendor-header">
                                <div>
                                    <div class="vendor-name">Gelato</div>
                                    <div class="vendor-type">Global Print</div>
                                </div>
                                <span class="status-badge disconnected" id="status-gelato">Not Connected</span>
                            </div>
                            <div class="vendor-fields">
                                <div class="form__group">
                                    <label class="form__label">API Key</label>
                                    <input type="password" id="gelato-api-key" class="form__input" placeholder="Enter Gelato API Key">
                                </div>
                            </div>
                            <div class="vendor-actions">
                                <button class="btn btn--outline btn--sm" onclick="testIntegration('gelato')">Test</button>
                                <button class="btn btn--primary btn--sm" onclick="saveIntegration('gelato')">Save</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dropshipping Tab -->
                <div id="int-tab-dropship" class="int-tab-content">
                    <div class="vendor-grid">
                        <!-- CJ Dropshipping -->
                        <div class="vendor-card">
                            <div class="vendor-header">
                                <div>
                                    <div class="vendor-name">CJ Dropshipping</div>
                                    <div class="vendor-type">Dropshipping</div>
                                </div>
                                <span class="status-badge disconnected" id="status-cj">Not Connected</span>
                            </div>
                            <div class="vendor-fields">
                                <div class="form__group">
                                    <label class="form__label">API Key</label>
                                    <input type="password" id="cj-api-key" class="form__input" placeholder="Enter CJ API Key">
                                </div>
                                <div class="form__group">
                                    <label class="form__label">Email</label>
                                    <input type="email" id="cj-email" class="form__input" placeholder="CJ Account Email">
                                </div>
                            </div>
                            <div class="vendor-actions">
                                <button class="btn btn--outline btn--sm" onclick="testIntegration('cj')">Test</button>
                                <button class="btn btn--primary btn--sm" onclick="saveIntegration('cj')">Save</button>
                            </div>
                        </div>

                        <!-- AliExpress -->
                        <div class="vendor-card">
                            <div class="vendor-header">
                                <div>
                                    <div class="vendor-name">AliExpress</div>
                                    <div class="vendor-type">Dropshipping</div>
                                </div>
                                <span class="status-badge disconnected" id="status-aliexpress">Not Connected</span>
                            </div>
                            <div class="vendor-fields">
                                <div class="form__group">
                                    <label class="form__label">App Key</label>
                                    <input type="password" id="aliexpress-app-key" class="form__input" placeholder="App Key">
                                </div>
                                <div class="form__group">
                                    <label class="form__label">App Secret</label>
                                    <input type="password" id="aliexpress-app-secret" class="form__input" placeholder="App Secret">
                                </div>
                            </div>
                            <div class="vendor-actions">
                                <button class="btn btn--outline btn--sm" onclick="testIntegration('aliexpress')">Test</button>
                                <button class="btn btn--primary btn--sm" onclick="saveIntegration('aliexpress')">Save</button>
                            </div>
                        </div>

                        <!-- Spocket -->
                        <div class="vendor-card">
                            <div class="vendor-header">
                                <div>
                                    <div class="vendor-name">Spocket</div>
                                    <div class="vendor-type">US/EU Dropshipping</div>
                                </div>
                                <span class="status-badge disconnected" id="status-spocket">Not Connected</span>
                            </div>
                            <div class="vendor-fields">
                                <div class="form__group">
                                    <label class="form__label">API Key</label>
                                    <input type="password" id="spocket-api-key" class="form__input" placeholder="Spocket API Key">
                                </div>
                            </div>
                            <div class="vendor-actions">
                                <button class="btn btn--outline btn--sm" onclick="testIntegration('spocket')">Test</button>
                                <button class="btn btn--primary btn--sm" onclick="saveIntegration('spocket')">Save</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shipping Tab -->
                <div id="int-tab-shipping" class="int-tab-content">
                    <div class="vendor-grid">
                        <!-- EasyPost -->
                        <div class="vendor-card">
                            <div class="vendor-header">
                                <div>
                                    <div class="vendor-name">EasyPost</div>
                                    <div class="vendor-type">Multi-Carrier</div>
                                </div>
                                <span class="status-badge disconnected" id="status-easypost">Not Connected</span>
                            </div>
                            <div class="vendor-fields">
                                <div class="form__group">
                                    <label class="form__label">API Key</label>
                                    <input type="password" id="easypost-api-key" class="form__input" placeholder="EasyPost API Key">
                                </div>
                            </div>
                            <div class="vendor-actions">
                                <button class="btn btn--outline btn--sm" onclick="testIntegration('easypost')">Test</button>
                                <button class="btn btn--primary btn--sm" onclick="saveIntegration('easypost')">Save</button>
                            </div>
                        </div>

                        <!-- ShipStation -->
                        <div class="vendor-card">
                            <div class="vendor-header">
                                <div>
                                    <div class="vendor-name">ShipStation</div>
                                    <div class="vendor-type">Shipping Platform</div>
                                </div>
                                <span class="status-badge disconnected" id="status-shipstation">Not Connected</span>
                            </div>
                            <div class="vendor-fields">
                                <div class="form__group">
                                    <label class="form__label">API Key</label>
                                    <input type="password" id="shipstation-api-key" class="form__input" placeholder="API Key">
                                </div>
                                <div class="form__group">
                                    <label class="form__label">API Secret</label>
                                    <input type="password" id="shipstation-api-secret" class="form__input" placeholder="API Secret">
                                </div>
                            </div>
                            <div class="vendor-actions">
                                <button class="btn btn--outline btn--sm" onclick="testIntegration('shipstation')">Test</button>
                                <button class="btn btn--primary btn--sm" onclick="saveIntegration('shipstation')">Save</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payments Tab -->
                <div id="int-tab-payments" class="int-tab-content">
                    <div class="alert-box" style="background: rgba(198, 142, 63, 0.1); border: 1px solid var(--whiskey); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
                        <strong>Adult-Friendly Processors Only</strong> - No Stripe/PayPal. These support adult content.
                    </div>
                    <div class="vendor-grid">
                        <!-- CCBill -->
                        <div class="vendor-card">
                            <div class="vendor-header">
                                <div>
                                    <div class="vendor-name">CCBill</div>
                                    <div class="vendor-type">#1 Adult Processor</div>
                                </div>
                                <span class="status-badge disconnected" id="status-ccbill">Not Connected</span>
                            </div>
                            <div class="vendor-fields">
                                <div class="form__group">
                                    <label class="form__label">Account Number</label>
                                    <input type="text" id="ccbill-account" class="form__input" placeholder="Account Number">
                                </div>
                                <div class="form__group">
                                    <label class="form__label">Sub-Account</label>
                                    <input type="text" id="ccbill-subaccount" class="form__input" placeholder="Sub-Account">
                                </div>
                                <div class="form__group">
                                    <label class="form__label">FlexForm ID</label>
                                    <input type="text" id="ccbill-flex-id" class="form__input" placeholder="FlexForm ID">
                                </div>
                                <div class="form__group">
                                    <label class="form__label">Salt Key</label>
                                    <input type="password" id="ccbill-salt" class="form__input" placeholder="Dynamic Pricing Salt">
                                </div>
                            </div>
                            <div class="vendor-actions">
                                <button class="btn btn--outline btn--sm" onclick="testIntegration('ccbill')">Test</button>
                                <button class="btn btn--primary btn--sm" onclick="saveIntegration('ccbill')">Save</button>
                            </div>
                        </div>

                        <!-- Epoch -->
                        <div class="vendor-card">
                            <div class="vendor-header">
                                <div>
                                    <div class="vendor-name">Epoch</div>
                                    <div class="vendor-type">Adult Processor</div>
                                </div>
                                <span class="status-badge disconnected" id="status-epoch">Not Connected</span>
                            </div>
                            <div class="vendor-fields">
                                <div class="form__group">
                                    <label class="form__label">Company ID</label>
                                    <input type="text" id="epoch-company-id" class="form__input" placeholder="Company ID">
                                </div>
                                <div class="form__group">
                                    <label class="form__label">API Key</label>
                                    <input type="password" id="epoch-api-key" class="form__input" placeholder="API Key">
                                </div>
                            </div>
                            <div class="vendor-actions">
                                <button class="btn btn--outline btn--sm" onclick="testIntegration('epoch')">Test</button>
                                <button class="btn btn--primary btn--sm" onclick="saveIntegration('epoch')">Save</button>
                            </div>
                        </div>

                        <!-- Segpay -->
                        <div class="vendor-card">
                            <div class="vendor-header">
                                <div>
                                    <div class="vendor-name">Segpay</div>
                                    <div class="vendor-type">Adult Processor</div>
                                </div>
                                <span class="status-badge disconnected" id="status-segpay">Not Connected</span>
                            </div>
                            <div class="vendor-fields">
                                <div class="form__group">
                                    <label class="form__label">Merchant ID</label>
                                    <input type="text" id="segpay-merchant-id" class="form__input" placeholder="Merchant ID">
                                </div>
                                <div class="form__group">
                                    <label class="form__label">API Key</label>
                                    <input type="password" id="segpay-api-key" class="form__input" placeholder="API Key">
                                </div>
                            </div>
                            <div class="vendor-actions">
                                <button class="btn btn--outline btn--sm" onclick="testIntegration('segpay')">Test</button>
                                <button class="btn btn--primary btn--sm" onclick="saveIntegration('segpay')">Save</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Crypto Tab -->
                <div id="int-tab-crypto" class="int-tab-content">
                    <div class="vendor-grid">
                        <!-- NOWPayments -->
                        <div class="vendor-card">
                            <div class="vendor-header">
                                <div>
                                    <div class="vendor-name">NOWPayments</div>
                                    <div class="vendor-type">Crypto (Adult-Friendly)</div>
                                </div>
                                <span class="status-badge disconnected" id="status-nowpayments">Not Connected</span>
                            </div>
                            <div class="vendor-fields">
                                <div class="form__group">
                                    <label class="form__label">API Key</label>
                                    <input type="password" id="nowpayments-api-key" class="form__input" placeholder="API Key">
                                </div>
                            </div>
                            <div class="vendor-actions">
                                <button class="btn btn--outline btn--sm" onclick="testIntegration('nowpayments')">Test</button>
                                <button class="btn btn--primary btn--sm" onclick="saveIntegration('nowpayments')">Save</button>
                            </div>
                        </div>

                        <!-- Coinbase Commerce -->
                        <div class="vendor-card">
                            <div class="vendor-header">
                                <div>
                                    <div class="vendor-name">Coinbase Commerce</div>
                                    <div class="vendor-type">Cryptocurrency</div>
                                </div>
                                <span class="status-badge disconnected" id="status-coinbase">Not Connected</span>
                            </div>
                            <div class="vendor-fields">
                                <div class="form__group">
                                    <label class="form__label">API Key</label>
                                    <input type="password" id="coinbase-api-key" class="form__input" placeholder="API Key">
                                </div>
                                <div class="form__group">
                                    <label class="form__label">Webhook Secret</label>
                                    <input type="password" id="coinbase-webhook" class="form__input" placeholder="Webhook Secret">
                                </div>
                            </div>
                            <div class="vendor-actions">
                                <button class="btn btn--outline btn--sm" onclick="testIntegration('coinbase')">Test</button>
                                <button class="btn btn--primary btn--sm" onclick="saveIntegration('coinbase')">Save</button>
                            </div>
                        </div>

                        <!-- Plisio -->
                        <div class="vendor-card">
                            <div class="vendor-header">
                                <div>
                                    <div class="vendor-name">Plisio</div>
                                    <div class="vendor-type">Crypto (Adult-Friendly)</div>
                                </div>
                                <span class="status-badge disconnected" id="status-plisio">Not Connected</span>
                            </div>
                            <div class="vendor-fields">
                                <div class="form__group">
                                    <label class="form__label">API Key</label>
                                    <input type="password" id="plisio-api-key" class="form__input" placeholder="API Key">
                                </div>
                            </div>
                            <div class="vendor-actions">
                                <button class="btn btn--outline btn--sm" onclick="testIntegration('plisio')">Test</button>
                                <button class="btn btn--primary btn--sm" onclick="saveIntegration('plisio')">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Requests Panel -->
            <div class="panel" id="panel-requests">
                <div class="panel-header">
                    <h2>Custom Requests</h2>
                    <select id="requestFilter" class="tier-select" onchange="loadRequests()">
                        <option value="">All Requests</option>
                        <option value="new">New</option>
                        <option value="reviewed">Reviewed</option>
                        <option value="approved">Approved</option>
                        <option value="in_progress">In Progress</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="table-container">
                    <table class="admin-table" id="requestsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Price</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="requestsBody">
                            <tr><td colspan="7" class="empty-state">Loading requests...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Subscribers Panel -->
            <div class="panel" id="panel-subscribers">
                <div class="panel-header">
                    <h2>Email Subscribers</h2>
                    <button class="btn btn--secondary" onclick="exportSubscribers()">Export CSV</button>
                </div>
                <div class="admin-stats" style="margin-bottom: var(--space-xl);">
                    <div class="admin-stat">
                        <div class="admin-stat__value" id="total-subscribers">0</div>
                        <div class="admin-stat__label">Total Subscribers</div>
                    </div>
                </div>
                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Source</th>
                                <th>Subscribed</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="subscribersBody">
                            <tr><td colspan="4" class="empty-state">Loading subscribers...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Theme Editor Panel -->
            <div class="panel" id="panel-theme">
                <div class="panel-header">
                    <h2>Theme Editor</h2>
                    <div style="display: flex; gap: var(--space-md);">
                        <button class="btn btn--secondary btn--sm" onclick="exportTheme()">
                            <span style="margin-right: 4px;">üì§</span> Export
                        </button>
                        <button class="btn btn--secondary btn--sm" onclick="document.getElementById('themeImport').click()">
                            <span style="margin-right: 4px;">üì•</span> Import
                        </button>
                        <input type="file" id="themeImport" accept=".json" style="display: none;" onchange="importTheme(event)">
                        <button class="btn btn--primary btn--sm" onclick="saveTheme()">
                            <span style="margin-right: 4px;">üíæ</span> Save Theme
                        </button>
                    </div>
                </div>

                <!-- Theme Presets Section -->
                <div class="theme-section" style="margin-bottom: var(--space-xl);">
                    <h3 style="margin-bottom: var(--space-md); color: var(--text-primary);">üé® Theme Presets</h3>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-lg);">Choose a starting point or create your own custom theme</p>
                    <div class="theme-presets-grid" id="themePresetsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: var(--space-md);">
                        <!-- Presets loaded dynamically -->
                    </div>
                </div>

                <!-- Color Editor Section -->
                <div class="theme-section" style="margin-bottom: var(--space-xl); padding: var(--space-lg); background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px solid var(--border-subtle);">
                    <h3 style="margin-bottom: var(--space-lg); color: var(--text-primary);">üé® Colors</h3>
                    <div class="color-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: var(--space-lg);">
                        <div class="color-control">
                            <label>Primary Color</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="color-primary" value="#C19A6B" onchange="updateThemeColor('primary', this.value)">
                                <input type="text" class="color-hex" value="#C19A6B" onchange="updateThemeColorHex('primary', this.value)">
                            </div>
                        </div>
                        <div class="color-control">
                            <label>Secondary Color</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="color-secondary" value="#8B7355" onchange="updateThemeColor('secondary', this.value)">
                                <input type="text" class="color-hex" value="#8B7355" onchange="updateThemeColorHex('secondary', this.value)">
                            </div>
                        </div>
                        <div class="color-control">
                            <label>Accent Color</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="color-accent" value="#D4AF37" onchange="updateThemeColor('accent', this.value)">
                                <input type="text" class="color-hex" value="#D4AF37" onchange="updateThemeColorHex('accent', this.value)">
                            </div>
                        </div>
                        <div class="color-control">
                            <label>Background</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="color-background" value="#0A0A0A" onchange="updateThemeColor('background', this.value)">
                                <input type="text" class="color-hex" value="#0A0A0A" onchange="updateThemeColorHex('background', this.value)">
                            </div>
                        </div>
                        <div class="color-control">
                            <label>Surface Color</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="color-surface" value="#141414" onchange="updateThemeColor('surface', this.value)">
                                <input type="text" class="color-hex" value="#141414" onchange="updateThemeColorHex('surface', this.value)">
                            </div>
                        </div>
                        <div class="color-control">
                            <label>Card Background</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="color-cardBg" value="#1A1A1A" onchange="updateThemeColor('cardBg', this.value)">
                                <input type="text" class="color-hex" value="#1A1A1A" onchange="updateThemeColorHex('cardBg', this.value)">
                            </div>
                        </div>
                        <div class="color-control">
                            <label>Text Primary</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="color-textPrimary" value="#F5F5F5" onchange="updateThemeColor('textPrimary', this.value)">
                                <input type="text" class="color-hex" value="#F5F5F5" onchange="updateThemeColorHex('textPrimary', this.value)">
                            </div>
                        </div>
                        <div class="color-control">
                            <label>Text Secondary</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="color-textSecondary" value="#A0A0A0" onchange="updateThemeColor('textSecondary', this.value)">
                                <input type="text" class="color-hex" value="#A0A0A0" onchange="updateThemeColorHex('textSecondary', this.value)">
                            </div>
                        </div>
                        <div class="color-control">
                            <label>Border Color</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="color-border" value="#2A2A2A" onchange="updateThemeColor('border', this.value)">
                                <input type="text" class="color-hex" value="#2A2A2A" onchange="updateThemeColorHex('border', this.value)">
                            </div>
                        </div>
                        <div class="color-control">
                            <label>Success Color</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="color-success" value="#4ADE80" onchange="updateThemeColor('success', this.value)">
                                <input type="text" class="color-hex" value="#4ADE80" onchange="updateThemeColorHex('success', this.value)">
                            </div>
                        </div>
                        <div class="color-control">
                            <label>Warning Color</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="color-warning" value="#FBBF24" onchange="updateThemeColor('warning', this.value)">
                                <input type="text" class="color-hex" value="#FBBF24" onchange="updateThemeColorHex('warning', this.value)">
                            </div>
                        </div>
                        <div class="color-control">
                            <label>Error Color</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="color-error" value="#F87171" onchange="updateThemeColor('error', this.value)">
                                <input type="text" class="color-hex" value="#F87171" onchange="updateThemeColorHex('error', this.value)">
                            </div>
                        </div>
                        <div class="color-control">
                            <label>Gradient Start</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="color-gradientStart" value="#C19A6B" onchange="updateThemeColor('gradientStart', this.value)">
                                <input type="text" class="color-hex" value="#C19A6B" onchange="updateThemeColorHex('gradientStart', this.value)">
                            </div>
                        </div>
                        <div class="color-control">
                            <label>Gradient End</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="color-gradientEnd" value="#8B7355" onchange="updateThemeColor('gradientEnd', this.value)">
                                <input type="text" class="color-hex" value="#8B7355" onchange="updateThemeColorHex('gradientEnd', this.value)">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Typography Section -->
                <div class="theme-section" style="margin-bottom: var(--space-xl); padding: var(--space-lg); background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px solid var(--border-subtle);">
                    <h3 style="margin-bottom: var(--space-lg); color: var(--text-primary);">üìù Typography</h3>
                    <div class="typography-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: var(--space-lg);">
                        <div class="typography-control">
                            <label>Heading Font</label>
                            <select id="typo-headingFont" onchange="updateTypography('headingFont', this.value)">
                                <option value="Playfair Display">Playfair Display</option>
                                <option value="Oswald">Oswald</option>
                                <option value="Bebas Neue">Bebas Neue</option>
                                <option value="Montserrat">Montserrat</option>
                                <option value="Poppins">Poppins</option>
                                <option value="Raleway">Raleway</option>
                                <option value="Lora">Lora</option>
                                <option value="Roboto Slab">Roboto Slab</option>
                                <option value="Dancing Script">Dancing Script</option>
                                <option value="Cinzel">Cinzel</option>
                            </select>
                        </div>
                        <div class="typography-control">
                            <label>Body Font</label>
                            <select id="typo-bodyFont" onchange="updateTypography('bodyFont', this.value)">
                                <option value="Inter">Inter</option>
                                <option value="Open Sans">Open Sans</option>
                                <option value="Roboto">Roboto</option>
                                <option value="Lato">Lato</option>
                                <option value="Source Sans Pro">Source Sans Pro</option>
                                <option value="Nunito">Nunito</option>
                                <option value="Work Sans">Work Sans</option>
                                <option value="DM Sans">DM Sans</option>
                            </select>
                        </div>
                        <div class="typography-control">
                            <label>Base Font Size</label>
                            <div class="range-with-value">
                                <input type="range" id="typo-baseFontSize" min="14" max="20" value="16" onchange="updateTypography('baseFontSize', this.value + 'px')">
                                <span id="typo-baseFontSize-value">16px</span>
                            </div>
                        </div>
                        <div class="typography-control">
                            <label>Heading Weight</label>
                            <select id="typo-headingWeight" onchange="updateTypography('headingWeight', this.value)">
                                <option value="400">Regular (400)</option>
                                <option value="500">Medium (500)</option>
                                <option value="600">Semi-Bold (600)</option>
                                <option value="700" selected>Bold (700)</option>
                                <option value="800">Extra Bold (800)</option>
                                <option value="900">Black (900)</option>
                            </select>
                        </div>
                        <div class="typography-control">
                            <label>Body Weight</label>
                            <select id="typo-bodyWeight" onchange="updateTypography('bodyWeight', this.value)">
                                <option value="300">Light (300)</option>
                                <option value="400" selected>Regular (400)</option>
                                <option value="500">Medium (500)</option>
                                <option value="600">Semi-Bold (600)</option>
                            </select>
                        </div>
                        <div class="typography-control">
                            <label>Line Height</label>
                            <div class="range-with-value">
                                <input type="range" id="typo-lineHeight" min="1.2" max="2" step="0.1" value="1.6" onchange="updateTypography('lineHeight', this.value)">
                                <span id="typo-lineHeight-value">1.6</span>
                            </div>
                        </div>
                        <div class="typography-control">
                            <label>Letter Spacing</label>
                            <div class="range-with-value">
                                <input type="range" id="typo-letterSpacing" min="-0.05" max="0.2" step="0.01" value="0" onchange="updateTypography('letterSpacing', this.value + 'em')">
                                <span id="typo-letterSpacing-value">0em</span>
                            </div>
                        </div>
                        <div class="typography-control">
                            <label>Heading Letter Spacing</label>
                            <div class="range-with-value">
                                <input type="range" id="typo-headingLetterSpacing" min="-0.05" max="0.3" step="0.01" value="0.02" onchange="updateTypography('headingLetterSpacing', this.value + 'em')">
                                <span id="typo-headingLetterSpacing-value">0.02em</span>
                            </div>
                        </div>
                    </div>
                    <!-- Typography Preview -->
                    <div class="typography-preview" style="margin-top: var(--space-xl); padding: var(--space-lg); background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-subtle);">
                        <h4 style="margin-bottom: var(--space-sm); color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase;">Preview</h4>
                        <h2 id="typo-preview-heading" style="margin-bottom: var(--space-md);">The Quick Brown Fox Jumps Over</h2>
                        <p id="typo-preview-body" style="color: var(--text-secondary);">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation.</p>
                    </div>
                </div>

                <!-- Background Section -->
                <div class="theme-section" style="margin-bottom: var(--space-xl); padding: var(--space-lg); background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px solid var(--border-subtle);">
                    <h3 style="margin-bottom: var(--space-lg); color: var(--text-primary);">üñºÔ∏è Background</h3>
                    <div class="background-controls" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: var(--space-lg);">
                        <div class="background-control">
                            <label>Background Type</label>
                            <select id="bg-type" onchange="updateBackground('type', this.value); toggleBackgroundOptions()">
                                <option value="solid">Solid Color</option>
                                <option value="gradient">Gradient</option>
                                <option value="image">Image</option>
                            </select>
                        </div>
                        <div class="background-control" id="bg-value-wrapper">
                            <label>Background Value</label>
                            <input type="text" id="bg-value" placeholder="Color, gradient CSS, or image URL" onchange="updateBackground('value', this.value)">
                        </div>
                        <div class="background-control">
                            <label>Overlay Opacity</label>
                            <div class="range-with-value">
                                <input type="range" id="bg-overlay" min="0" max="1" step="0.05" value="0.9" onchange="updateBackground('overlay', this.value)">
                                <span id="bg-overlay-value">0.9</span>
                            </div>
                        </div>
                        <div class="background-control">
                            <label>Pattern Overlay</label>
                            <select id="bg-pattern" onchange="updateBackground('pattern', this.value)">
                                <option value="none">None</option>
                                <option value="dots">Dots</option>
                                <option value="grid">Grid</option>
                                <option value="diagonal">Diagonal Lines</option>
                                <option value="noise">Noise Texture</option>
                                <option value="leather">Leather Texture</option>
                            </select>
                        </div>
                    </div>
                    <!-- Background Preview -->
                    <div id="bg-preview" style="margin-top: var(--space-lg); height: 150px; border-radius: 8px; border: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: center;">
                        <span style="color: var(--text-secondary);">Background Preview</span>
                    </div>
                </div>

                <!-- Effects Section -->
                <div class="theme-section" style="margin-bottom: var(--space-xl); padding: var(--space-lg); background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px solid var(--border-subtle);">
                    <h3 style="margin-bottom: var(--space-lg); color: var(--text-primary);">‚ú® Effects & Styling</h3>
                    <div class="effects-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: var(--space-lg);">
                        <div class="effect-control">
                            <label>Border Radius</label>
                            <div class="range-with-value">
                                <input type="range" id="effect-borderRadius" min="0" max="24" value="12" onchange="updateEffect('borderRadius', this.value + 'px')">
                                <span id="effect-borderRadius-value">12px</span>
                            </div>
                        </div>
                        <div class="effect-control">
                            <label>Card Shadow</label>
                            <select id="effect-cardShadow" onchange="updateEffect('cardShadow', this.value)">
                                <option value="none">None</option>
                                <option value="sm">Small</option>
                                <option value="md" selected>Medium</option>
                                <option value="lg">Large</option>
                                <option value="xl">Extra Large</option>
                                <option value="glow">Glow Effect</option>
                            </select>
                        </div>
                        <div class="effect-control">
                            <label>Glow Effect</label>
                            <div class="toggle-wrapper">
                                <input type="checkbox" id="effect-glowEffect" onchange="updateEffect('glowEffect', this.checked)">
                                <label for="effect-glowEffect" class="toggle-label">Enable accent glow on hover</label>
                            </div>
                        </div>
                        <div class="effect-control">
                            <label>Animations</label>
                            <div class="toggle-wrapper">
                                <input type="checkbox" id="effect-animations" checked onchange="updateEffect('animations', this.checked)">
                                <label for="effect-animations" class="toggle-label">Enable hover animations</label>
                            </div>
                        </div>
                    </div>
                    <!-- Effects Preview Cards -->
                    <div style="margin-top: var(--space-lg); display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-md);">
                        <div class="effect-preview-card" style="padding: var(--space-lg); background: var(--card-bg); border-radius: var(--radius-lg); border: 1px solid var(--border-subtle); text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: var(--space-sm);">üì∏</div>
                            <div style="font-weight: 600;">Card Preview</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Hover to test</div>
                        </div>
                        <div class="effect-preview-card" style="padding: var(--space-lg); background: var(--card-bg); border-radius: var(--radius-lg); border: 1px solid var(--border-subtle); text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: var(--space-sm);">üé¨</div>
                            <div style="font-weight: 600;">Card Preview</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Hover to test</div>
                        </div>
                        <div class="effect-preview-card" style="padding: var(--space-lg); background: var(--card-bg); border-radius: var(--radius-lg); border: 1px solid var(--border-subtle); text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: var(--space-sm);">‚≠ê</div>
                            <div style="font-weight: 600;">Card Preview</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Hover to test</div>
                        </div>
                    </div>
                </div>

                <!-- Reset & Actions -->
                <div class="theme-actions" style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-lg); background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px solid var(--border-subtle);">
                    <button class="btn btn--danger btn--sm" onclick="resetTheme()">
                        <span style="margin-right: 4px;">üîÑ</span> Reset to Default
                    </button>
                    <div style="display: flex; gap: var(--space-md);">
                        <button class="btn btn--secondary" onclick="previewTheme()">
                            <span style="margin-right: 4px;">üëÅÔ∏è</span> Preview Live
                        </button>
                        <button class="btn btn--primary" onclick="saveAndPublishTheme()">
                            <span style="margin-right: 4px;">üöÄ</span> Save & Publish
                        </button>
                    </div>
                </div>
            </div>

            <!-- Analytics Panel -->
            <div class="panel" id="panel-analytics">
                <div class="panel-header">
                    <h2>Analytics Dashboard</h2>
                    <div style="display: flex; gap: var(--space-md); align-items: center;">
                        <select id="analyticsDays" class="tier-select" onchange="loadCustomAnalytics()">
                            <option value="7">Last 7 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                        </select>
                        <button class="btn btn--secondary btn--sm" onclick="loadCustomAnalytics()">
                            <span style="margin-right: 4px;">&#x21bb;</span> Refresh
                        </button>
                    </div>
                </div>

                <!-- Real-time Visitors Banner -->
                <div class="realtime-banner" style="background: linear-gradient(135deg, rgba(193,154,107,0.15), rgba(193,154,107,0.05)); border: 1px solid rgba(193,154,107,0.3); border-radius: 12px; padding: var(--space-lg); margin-bottom: var(--space-xl); display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: var(--space-md);">
                        <div class="realtime-pulse" style="width: 12px; height: 12px; background: #4ade80; border-radius: 50%; animation: pulse 2s infinite;"></div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary);" id="realtimeCount">0</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Active visitors right now</div>
                        </div>
                    </div>
                    <div id="realtimeVisitorsList" style="display: flex; gap: var(--space-sm); flex-wrap: wrap; max-width: 60%;">
                        <!-- Real-time visitor pills will be inserted here -->
                    </div>
                </div>

                <!-- Key Metrics Cards -->
                <div class="admin-stats" style="margin-bottom: var(--space-xl);">
                    <div class="admin-stat">
                        <div class="admin-stat__value" id="stat-visitors">-</div>
                        <div class="admin-stat__label">Unique Visitors</div>
                        <div class="stat-comparison" id="stat-visitors-change"></div>
                    </div>
                    <div class="admin-stat">
                        <div class="admin-stat__value" id="stat-sessions">-</div>
                        <div class="admin-stat__label">Sessions</div>
                        <div class="stat-comparison" id="stat-sessions-change"></div>
                    </div>
                    <div class="admin-stat">
                        <div class="admin-stat__value" id="stat-pageviews">-</div>
                        <div class="admin-stat__label">Page Views</div>
                        <div class="stat-comparison" id="stat-pageviews-change"></div>
                    </div>
                    <div class="admin-stat">
                        <div class="admin-stat__value" id="stat-avgduration">-</div>
                        <div class="admin-stat__label">Avg. Session Duration</div>
                        <div class="stat-comparison" id="stat-duration-change"></div>
                    </div>
                    <div class="admin-stat">
                        <div class="admin-stat__value" id="stat-bounce">-</div>
                        <div class="admin-stat__label">Bounce Rate</div>
                        <div class="stat-comparison" id="stat-bounce-change"></div>
                    </div>
                </div>

                <!-- Traffic Chart -->
                <div class="settings-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
                        <h3>Traffic Overview</h3>
                        <div class="chart-legend" style="display: flex; gap: var(--space-lg);">
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="checkbox" id="showVisitors" checked onchange="updateTrafficChart()">
                                <span style="width: 12px; height: 3px; background: #c19a6b; border-radius: 2px;"></span>
                                <span style="font-size: 0.85rem; color: var(--text-secondary);">Visitors</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="checkbox" id="showPageviews" checked onchange="updateTrafficChart()">
                                <span style="width: 12px; height: 3px; background: #60a5fa; border-radius: 2px;"></span>
                                <span style="font-size: 0.85rem; color: var(--text-secondary);">Page Views</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="checkbox" id="showSessions" onchange="updateTrafficChart()">
                                <span style="width: 12px; height: 3px; background: #a78bfa; border-radius: 2px;"></span>
                                <span style="font-size: 0.85rem; color: var(--text-secondary);">Sessions</span>
                            </label>
                        </div>
                    </div>
                    <div id="trafficChart" style="height: 280px; position: relative; background: rgba(0,0,0,0.2); border-radius: 8px; padding: var(--space-md);">
                        <svg id="trafficChartSvg" width="100%" height="100%" style="overflow: visible;"></svg>
                    </div>
                </div>

                <!-- Two Column Layout: Pages & Sources -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-xl); margin-top: var(--space-xl);">
                    <!-- Top Pages -->
                    <div class="settings-section" style="margin: 0;">
                        <h3>Top Pages</h3>
                        <div class="table-container" style="max-height: 350px; overflow-y: auto;">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Page</th>
                                        <th style="text-align: right;">Views</th>
                                        <th style="text-align: right;">Unique</th>
                                        <th style="text-align: right;">Avg. Time</th>
                                    </tr>
                                </thead>
                                <tbody id="topPagesBody">
                                    <tr><td colspan="4" class="empty-state">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Traffic Sources -->
                    <div class="settings-section" style="margin: 0;">
                        <h3>Traffic Sources</h3>
                        <div class="table-container" style="max-height: 350px; overflow-y: auto;">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Source</th>
                                        <th style="text-align: right;">Visitors</th>
                                        <th style="text-align: right;">Sessions</th>
                                        <th style="text-align: right;">Bounce</th>
                                    </tr>
                                </thead>
                                <tbody id="trafficSourcesBody">
                                    <tr><td colspan="4" class="empty-state">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Three Column Layout: Devices, Browsers, Countries -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-xl); margin-top: var(--space-xl);">
                    <!-- Devices -->
                    <div class="settings-section" style="margin: 0;">
                        <h3>Devices</h3>
                        <div id="deviceBreakdown" style="padding: var(--space-md);">
                            <div class="breakdown-item">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span>Desktop</span>
                                    <span id="device-desktop-pct">0%</span>
                                </div>
                                <div class="progress-bar"><div class="progress-fill" id="device-desktop-bar" style="width: 0%;"></div></div>
                            </div>
                            <div class="breakdown-item" style="margin-top: var(--space-md);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span>Mobile</span>
                                    <span id="device-mobile-pct">0%</span>
                                </div>
                                <div class="progress-bar"><div class="progress-fill" id="device-mobile-bar" style="width: 0%; background: #60a5fa;"></div></div>
                            </div>
                            <div class="breakdown-item" style="margin-top: var(--space-md);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span>Tablet</span>
                                    <span id="device-tablet-pct">0%</span>
                                </div>
                                <div class="progress-bar"><div class="progress-fill" id="device-tablet-bar" style="width: 0%; background: #a78bfa;"></div></div>
                            </div>
                        </div>
                    </div>

                    <!-- Browsers -->
                    <div class="settings-section" style="margin: 0;">
                        <h3>Browsers</h3>
                        <div id="browserBreakdown" style="padding: var(--space-md);">
                            <p style="color: var(--text-muted);">Loading...</p>
                        </div>
                    </div>

                    <!-- Countries -->
                    <div class="settings-section" style="margin: 0;">
                        <h3>Top Countries</h3>
                        <div id="countryBreakdown" style="padding: var(--space-md);">
                            <p style="color: var(--text-muted);">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Events -->
                <div class="settings-section" style="margin-top: var(--space-xl);">
                    <h3>Recent Events</h3>
                    <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Category</th>
                                    <th>Action</th>
                                    <th>Label</th>
                                    <th>Page</th>
                                </tr>
                            </thead>
                            <tbody id="recentEventsBody">
                                <tr><td colspan="5" class="empty-state">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Third Party Integrations (Collapsed) -->
                <details class="settings-section" style="margin-top: var(--space-xl);">
                    <summary style="cursor: pointer; font-weight: 600; font-size: 1.1rem; padding: var(--space-sm) 0;">Third-Party Analytics Integrations</summary>

                    <!-- Google Analytics 4 Setup -->
                    <div style="margin-top: var(--space-lg);">
                        <h4 style="margin-bottom: var(--space-md);">Google Analytics 4</h4>
                        <form id="ga4SettingsForm">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-md);">
                                <div class="form__group">
                                    <label class="form__label">GA4 Measurement ID</label>
                                    <input type="text" id="ga4MeasurementId" class="form__input" placeholder="G-XXXXXXXXXX">
                                </div>
                                <div class="form__group">
                                    <label class="form__label">Status</label>
                                    <div style="display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-sm) 0;">
                                        <span class="health-dot" id="ga4-status"></span>
                                        <span id="ga4-status-text">Not configured</span>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn--primary btn--sm" style="margin-top: var(--space-md);">Save GA4 Settings</button>
                        </form>
                    </div>

                    <!-- Other Integrations Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--space-lg); margin-top: var(--space-xl);">
                        <!-- Facebook Pixel -->
                        <div class="vendor-card">
                            <div class="vendor-header">
                                <div>
                                    <div class="vendor-name">Meta/Facebook Pixel</div>
                                    <div class="vendor-type">Conversion Tracking</div>
                                </div>
                                <span class="status-badge disconnected" id="status-fbpixel">Not Set</span>
                            </div>
                            <div class="form__group">
                                <label class="form__label">Pixel ID</label>
                                <input type="text" id="fbPixelId" class="form__input" placeholder="123456789012345">
                            </div>
                            <button class="btn btn--primary btn--sm" onclick="saveAnalyticsIntegration('fbpixel')">Save</button>
                        </div>

                        <!-- TikTok Pixel -->
                        <div class="vendor-card">
                            <div class="vendor-header">
                                <div>
                                    <div class="vendor-name">TikTok Pixel</div>
                                    <div class="vendor-type">Conversion Tracking</div>
                                </div>
                                <span class="status-badge disconnected" id="status-tiktokpixel">Not Set</span>
                            </div>
                            <div class="form__group">
                                <label class="form__label">Pixel ID</label>
                                <input type="text" id="tiktokPixelId" class="form__input" placeholder="XXXXXXXXXXXXXXXX">
                            </div>
                            <button class="btn btn--primary btn--sm" onclick="saveAnalyticsIntegration('tiktokpixel')">Save</button>
                        </div>

                        <!-- Hotjar -->
                        <div class="vendor-card">
                            <div class="vendor-header">
                                <div>
                                    <div class="vendor-name">Hotjar</div>
                                    <div class="vendor-type">Heatmaps & Recordings</div>
                                </div>
                                <span class="status-badge disconnected" id="status-hotjar">Not Set</span>
                            </div>
                            <div class="form__group">
                                <label class="form__label">Site ID</label>
                                <input type="text" id="hotjarSiteId" class="form__input" placeholder="1234567">
                            </div>
                            <button class="btn btn--primary btn--sm" onclick="saveAnalyticsIntegration('hotjar')">Save</button>
                        </div>

                        <!-- Clarity -->
                        <div class="vendor-card">
                            <div class="vendor-header">
                                <div>
                                    <div class="vendor-name">Microsoft Clarity</div>
                                    <div class="vendor-type">Heatmaps (Free)</div>
                                </div>
                                <span class="status-badge disconnected" id="status-clarity">Not Set</span>
                            </div>
                            <div class="form__group">
                                <label class="form__label">Project ID</label>
                                <input type="text" id="clarityProjectId" class="form__input" placeholder="abcdefghij">
                            </div>
                            <button class="btn btn--primary btn--sm" onclick="saveAnalyticsIntegration('clarity')">Save</button>
                        </div>
                    </div>
                </details>

                <!-- Platform Click Analytics (Legacy) -->
                <details class="settings-section" style="margin-top: var(--space-xl);">
                    <summary style="cursor: pointer; font-weight: 600; font-size: 1.1rem; padding: var(--space-sm) 0;">Platform Link Clicks (Legacy)</summary>
                    <div style="margin-top: var(--space-lg);">
                        <div class="admin-stats">
                            <div class="admin-stat">
                                <div class="admin-stat__value" id="analytics-total">0</div>
                                <div class="admin-stat__label">Total Platform Clicks</div>
                            </div>
                        </div>
                        <div id="analyticsChart" style="display: grid; gap: var(--space-md); margin-top: var(--space-md);">
                            <p style="color: var(--text-muted);">Loading analytics...</p>
                        </div>
                    </div>
                </details>
            </div>

            <!-- Security Panel -->
            <div class="panel" id="panel-security">
                <div class="panel-header">
                    <h2>Security & Logs</h2>
                </div>
                <div class="settings-section">
                    <h3>Recent Login Attempts</h3>
                    <div class="table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Username</th>
                                    <th>IP Address</th>
                                    <th>Status</th>
                                    <th>Reason</th>
                                </tr>
                            </thead>
                            <tbody id="loginLogsBody">
                                <tr><td colspan="5" class="empty-state">Loading logs...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Panel -->
            <div class="panel" id="panel-settings">
                <div class="panel-header">
                    <h2>Site Settings</h2>
                </div>

                <div class="settings-section">
                    <h3>Site Info</h3>
                    <form id="siteSettingsForm">
                        <div class="form__group">
                            <label class="form__label">Tagline</label>
                            <input type="text" id="settingTagline" class="form__input" value="Country Bred. Fully Loaded.">
                        </div>
                        <div class="form__group">
                            <label class="form__label">Review Count</label>
                            <input type="number" id="settingReviews" class="form__input" value="132">
                        </div>
                        <div class="form__group">
                            <label class="form__label">Contact Email</label>
                            <input type="email" id="settingEmail" class="form__input" value="wyatt@wyattxxxcole.com">
                        </div>
                        <button type="submit" class="btn btn--primary">Save Settings</button>
                    </form>
                </div>

                <div class="settings-section">
                    <h3>Social Media Links</h3>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-lg);">
                        Add your social media profile URLs. These will appear in the footer and on your profile.
                    </p>
                    <form id="socialSettingsForm">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-md);">
                            <div class="form__group">
                                <label class="form__label">X (Twitter)</label>
                                <input type="url" id="socialTwitter" class="form__input" placeholder="https://x.com/username">
                            </div>
                            <div class="form__group">
                                <label class="form__label">Instagram</label>
                                <input type="url" id="socialInstagram" class="form__input" placeholder="https://instagram.com/username">
                            </div>
                            <div class="form__group">
                                <label class="form__label">Bluesky</label>
                                <input type="url" id="socialBluesky" class="form__input" placeholder="https://bsky.app/profile/username">
                            </div>
                            <div class="form__group">
                                <label class="form__label">TikTok</label>
                                <input type="url" id="socialTiktok" class="form__input" placeholder="https://tiktok.com/@username">
                            </div>
                            <div class="form__group">
                                <label class="form__label">BoyFanz</label>
                                <input type="url" id="socialBoyfanz" class="form__input" placeholder="https://boy.fanz.website/username">
                            </div>
                            <div class="form__group">
                                <label class="form__label">YouTube</label>
                                <input type="url" id="socialYoutube" class="form__input" placeholder="https://youtube.com/@username">
                            </div>
                            <div class="form__group">
                                <label class="form__label">Threads</label>
                                <input type="url" id="socialThreads" class="form__input" placeholder="https://threads.net/@username">
                            </div>
                            <div class="form__group">
                                <label class="form__label">Snapchat</label>
                                <input type="url" id="socialSnapchat" class="form__input" placeholder="https://snapchat.com/add/username">
                            </div>
                            <div class="form__group">
                                <label class="form__label">Discord</label>
                                <input type="url" id="socialDiscord" class="form__input" placeholder="https://discord.gg/invite-code">
                            </div>
                            <div class="form__group">
                                <label class="form__label">Telegram</label>
                                <input type="url" id="socialTelegram" class="form__input" placeholder="https://t.me/username">
                            </div>
                        </div>
                        <button type="submit" class="btn btn--primary" style="margin-top: var(--space-lg);">Save Social Links</button>
                    </form>
                </div>

                <div class="settings-section">
                    <h3>Change Password</h3>
                    <form id="passwordForm">
                        <div class="form__group">
                            <label class="form__label">Current Password</label>
                            <input type="password" id="currentPassword" class="form__input" required>
                        </div>
                        <div class="form__group">
                            <label class="form__label">New Password</label>
                            <input type="password" id="newPassword" class="form__input" required>
                        </div>
                        <div class="form__group">
                            <label class="form__label">Confirm Password</label>
                            <input type="password" id="confirmPassword" class="form__input" required>
                        </div>
                        <button type="submit" class="btn btn--rust">Update Password</button>
                    </form>
                </div>

                <div class="settings-section">
                    <h3>SMTP Email Settings</h3>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-lg);">
                        Configure your email server for sending verification codes and notifications.
                    </p>
                    <form id="smtpSettingsForm">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-md);">
                            <div class="form__group">
                                <label class="form__label">SMTP Host</label>
                                <input type="text" id="smtpHost" class="form__input" placeholder="smtp.gmail.com">
                            </div>
                            <div class="form__group">
                                <label class="form__label">SMTP Port</label>
                                <input type="number" id="smtpPort" class="form__input" placeholder="587" value="587">
                            </div>
                            <div class="form__group">
                                <label class="form__label">SMTP Username</label>
                                <input type="text" id="smtpUser" class="form__input" placeholder="your-email@gmail.com">
                            </div>
                            <div class="form__group">
                                <label class="form__label">SMTP Password</label>
                                <input type="password" id="smtpPass" class="form__input" placeholder="App password or SMTP password">
                            </div>
                            <div class="form__group">
                                <label class="form__label">From Email</label>
                                <input type="email" id="smtpFromEmail" class="form__input" placeholder="no-reply@wyattxxxcole.com">
                            </div>
                            <div class="form__group">
                                <label class="form__label">From Name</label>
                                <input type="text" id="smtpFromName" class="form__input" placeholder="Wyatt Admin">
                            </div>
                        </div>
                        <div style="display: flex; gap: var(--space-md); margin-top: var(--space-lg);">
                            <button type="submit" class="btn btn--primary">Save SMTP Settings</button>
                            <button type="button" class="btn btn--secondary" onclick="testSmtp()">Test Connection</button>
                        </div>
                    </form>
                </div>

                <div class="settings-section">
                    <h3>Admin Email</h3>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-lg);">
                        This email receives verification codes and admin notifications.
                    </p>
                    <form id="adminEmailForm">
                        <div class="form__group">
                            <label class="form__label">Admin Email Address</label>
                            <input type="email" id="adminEmail" class="form__input" placeholder="admin@wyattxxxcole.com">
                        </div>
                        <button type="submit" class="btn btn--primary">Save Admin Email</button>
                    </form>
                </div>

                <div class="settings-section">
                    <h3>Email Templates</h3>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-lg);">
                        Professional email marketing templates. Use variables like <code>{{NAME}}</code>, <code>{{BRAND_NAME}}</code>, etc.
                    </p>

                    <!-- Template Category Tabs -->
                    <div class="template-tabs" style="display: flex; gap: var(--space-sm); margin-bottom: var(--space-lg); flex-wrap: wrap;">
                        <button class="btn btn--sm template-tab active" onclick="filterTemplates('all')" data-category="all">All Templates</button>
                        <button class="btn btn--sm template-tab" onclick="filterTemplates('marketing')" data-category="marketing">Marketing</button>
                        <button class="btn btn--sm template-tab" onclick="filterTemplates('transactional')" data-category="transactional">Transactional</button>
                        <button class="btn btn--sm template-tab" onclick="filterTemplates('system')" data-category="system">System</button>
                    </div>

                    <!-- Template Selector -->
                    <div class="form__group" style="margin-bottom: var(--space-lg);">
                        <label class="form__label">Select Template to Edit</label>
                        <select id="templateSelector" class="form__input" onchange="loadSelectedTemplate()">
                            <option value="">-- Choose a template --</option>
                        </select>
                    </div>

                    <!-- Template Editor -->
                    <div id="templateEditor" style="display: none;">
                        <div class="template-info" style="background: rgba(193,154,107,0.1); padding: var(--space-md); border-radius: 8px; margin-bottom: var(--space-lg);">
                            <strong id="templateName" style="color: var(--whiskey);">Template Name</strong>
                            <span id="templateCategory" class="badge" style="margin-left: var(--space-sm); background: var(--surface); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">category</span>
                        </div>

                        <div style="display: grid; gap: var(--space-lg);">
                            <div class="form__group">
                                <label class="form__label">Email Subject Line</label>
                                <input type="text" id="templateSubject" class="form__input" placeholder="Enter email subject...">
                            </div>
                            <div class="form__group">
                                <label class="form__label">Email Body</label>
                                <textarea id="templateBody" class="form__input" rows="15" style="font-family: monospace; white-space: pre-wrap;"></textarea>
                            </div>

                            <!-- Available Variables -->
                            <div class="variables-help" style="background: var(--surface); padding: var(--space-md); border-radius: 8px;">
                                <strong style="color: var(--text-secondary); font-size: 0.85rem;">Available Variables:</strong>
                                <div style="display: flex; flex-wrap: wrap; gap: var(--space-sm); margin-top: var(--space-sm);">
                                    <code style="background: var(--card-bg); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; cursor: pointer;" onclick="insertVariable('{{NAME}}')">{{NAME}}</code>
                                    <code style="background: var(--card-bg); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; cursor: pointer;" onclick="insertVariable('{{BRAND_NAME}}')">{{BRAND_NAME}}</code>
                                    <code style="background: var(--card-bg); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; cursor: pointer;" onclick="insertVariable('{{TAGLINE}}')">{{TAGLINE}}</code>
                                    <code style="background: var(--card-bg); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; cursor: pointer;" onclick="insertVariable('{{UNSUBSCRIBE_LINK}}')">{{UNSUBSCRIBE_LINK}}</code>
                                    <code style="background: var(--card-bg); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; cursor: pointer;" onclick="insertVariable('{{DATE}}')">{{DATE}}</code>
                                </div>
                            </div>

                            <div style="display: flex; gap: var(--space-md);">
                                <button class="btn btn--secondary" onclick="previewTemplate()">Preview</button>
                                <button class="btn btn--primary" onclick="saveCurrentTemplate()">Save Template</button>
                            </div>
                        </div>
                    </div>

                    <!-- Template Preview Modal -->
                    <div id="templatePreviewModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; padding: var(--space-xl); overflow: auto;">
                        <div style="max-width: 600px; margin: 0 auto; background: white; color: #333; padding: var(--space-xl); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                                <strong>Email Preview</strong>
                                <button onclick="closeTemplatePreview()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                            </div>
                            <div style="border-bottom: 2px solid #eee; padding-bottom: var(--space-md); margin-bottom: var(--space-lg);">
                                <strong>Subject:</strong> <span id="previewSubject"></span>
                            </div>
                            <div id="previewBody" style="white-space: pre-wrap; line-height: 1.6;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Base URL
        const API_BASE = 'api/upload.php';

        // Token management
        let authToken = localStorage.getItem('adminToken') || '';

        // Check if logged in on load
        if (authToken) {
            showDashboard();
            loadGallery();
            loadSettings();
        }

        // Login form handler is defined in the VERIFICATION FLOW section at the bottom

        function showDashboard() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
        }

        function logout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('wyatt_admin_auth');
            authToken = '';
            location.reload();
        }

        // Panel navigation
        document.querySelectorAll('.dashboard-nav button').forEach(btn => {
            btn.addEventListener('click', () => switchPanel(btn.dataset.panel));
        });

        function switchPanel(panelName) {
            document.querySelectorAll('.dashboard-nav button').forEach(b => {
                b.classList.toggle('active', b.dataset.panel === panelName);
            });
            document.querySelectorAll('.panel').forEach(p => {
                p.classList.toggle('active', p.id === `panel-${panelName}`);
            });
        }

        // File upload helper
        async function uploadFile(file, action) {
            const formData = new FormData();
            formData.append('file', file);

            const res = await fetch(`${API_BASE}?action=${action}&token=${authToken}`, {
                method: 'POST',
                body: formData
            });

            return await res.json();
        }

        // Logo upload
        document.getElementById('logoUpload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const result = await uploadFile(file, 'upload-logo');
                if (result.success) {
                    document.querySelector('#logoPreview img').src = result.url + '?t=' + Date.now();
                    document.getElementById('logoPreview').style.display = 'block';
                    showNotification('Logo uploaded successfully!', 'success');
                } else {
                    showNotification(result.error || 'Upload failed', 'error');
                }
            } catch (err) {
                showNotification('Upload failed', 'error');
            }
        });

        // Hero upload
        document.getElementById('heroUpload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const result = await uploadFile(file, 'upload-hero');
                if (result.success) {
                    let preview = document.getElementById('heroPreview');
                    preview.innerHTML = `<img src="${result.url}?t=${Date.now()}" alt="Hero Image">`;
                    showNotification('Hero image uploaded successfully!', 'success');
                } else {
                    showNotification(result.error || 'Upload failed', 'error');
                }
            } catch (err) {
                showNotification('Upload failed', 'error');
            }
        });

        // Gallery upload (bulk)
        const galleryInputs = [
            document.getElementById('galleryUpload'),
            document.getElementById('galleryBulkUpload')
        ];

        galleryInputs.forEach(input => {
            input.addEventListener('change', async (e) => {
                const files = e.target.files;
                if (!files.length) return;

                const progressDiv = document.getElementById('galleryProgress');
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');

                progressDiv.style.display = 'block';
                let uploaded = 0;
                const total = files.length;

                for (let i = 0; i < files.length; i++) {
                    try {
                        progressText.textContent = `Uploading ${i + 1} of ${total}...`;
                        progressFill.style.width = ((i / total) * 100) + '%';

                        await uploadFile(files[i], 'upload-gallery');
                        uploaded++;
                    } catch (err) {
                        console.error('Failed to upload:', files[i].name);
                    }
                }

                progressFill.style.width = '100%';
                progressText.textContent = `Uploaded ${uploaded} of ${total} images`;

                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    progressFill.style.width = '0%';
                }, 2000);

                loadGallery();
                showNotification(`${uploaded} images uploaded!`, 'success');
                e.target.value = '';
            });
        });

        // Load gallery
        async function loadGallery() {
            try {
                const res = await fetch(`${API_BASE}?action=list-gallery&_=${Date.now()}`);
                const data = await res.json();

                const container = document.getElementById('galleryAdmin');
                const emptyState = document.getElementById('galleryEmpty');
                const countEl = document.getElementById('galleryCount');
                const statEl = document.getElementById('stat-gallery');

                if (data.success && data.images.length > 0) {
                    container.innerHTML = data.images.map(img => `
                        <div class="gallery-item-admin" data-filename="${img.filename}">
                            <img src="${img.url}" alt="" loading="lazy">
                            <button class="delete-btn" onclick="deleteGalleryImage('${img.filename}')">&times;</button>
                        </div>
                    `).join('');
                    emptyState.style.display = 'none';
                    countEl.textContent = data.images.length;
                    statEl.textContent = data.images.length;
                } else {
                    container.innerHTML = '';
                    emptyState.style.display = 'block';
                    countEl.textContent = '0';
                    statEl.textContent = '0';
                }
            } catch (err) {
                console.error('Failed to load gallery:', err);
            }
        }

        // Delete gallery image
        async function deleteGalleryImage(filename) {
            if (!confirm('Delete this image?')) return;

            try {
                const res = await fetch(`${API_BASE}?action=delete-gallery&token=${authToken}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename })
                });

                const data = await res.json();
                if (data.success) {
                    document.querySelector(`[data-filename="${filename}"]`).remove();
                    loadGallery();
                    showNotification('Image deleted', 'success');
                } else {
                    showNotification(data.error || 'Delete failed', 'error');
                }
            } catch (err) {
                showNotification('Delete failed', 'error');
            }
        }

        // Load settings
        async function loadSettings() {
            try {
                const res = await fetch(`${API_BASE}?action=get-settings`);
                const data = await res.json();

                if (data.success) {
                    document.getElementById('settingTagline').value = data.settings.tagline;
                    document.getElementById('settingReviews').value = data.settings.reviewCount;
                    document.getElementById('settingEmail').value = data.settings.contactEmail;

                    if (data.settings.heroUrl) {
                        document.getElementById('heroPreview').innerHTML =
                            `<img src="${data.settings.heroUrl}" alt="Hero">`;
                    }
                }
            } catch (err) {
                console.error('Failed to load settings:', err);
            }
        }

        // Save settings
        document.getElementById('siteSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const settings = {
                tagline: document.getElementById('settingTagline').value,
                reviewCount: document.getElementById('settingReviews').value,
                contactEmail: document.getElementById('settingEmail').value
            };

            try {
                const res = await fetch(`${API_BASE}?action=save-settings&token=${authToken}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                const data = await res.json();
                if (data.success) {
                    showNotification('Settings saved!', 'success');
                } else {
                    showNotification(data.error || 'Save failed', 'error');
                }
            } catch (err) {
                showNotification('Save failed', 'error');
            }
        });

        // Drag & drop support
        document.querySelectorAll('.upload-area').forEach(area => {
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('dragging');
            });
            area.addEventListener('dragleave', () => {
                area.classList.remove('dragging');
            });
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragging');
                const input = area.querySelector('input[type="file"]');
                if (input && e.dataTransfer.files.length) {
                    input.files = e.dataTransfer.files;
                    input.dispatchEvent(new Event('change'));
                }
            });
        });

        // Show notification
        function showNotification(message, type = 'success') {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.className = `notification notification--${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.remove(), 3000);
        }

        // ========== PRICING MANAGEMENT ==========
        const PRICING_API = 'api/pricing.php';
        let currentPricing = null;

        // Load pricing on dashboard load
        async function loadPricing() {
            try {
                const res = await fetch(`${PRICING_API}?action=get`);
                const data = await res.json();
                if (data.success) {
                    currentPricing = data.pricing;
                    populatePricingForms(data.pricing);
                }
            } catch (err) {
                console.error('Failed to load pricing:', err);
            }
        }

        // Populate form fields with current pricing
        function populatePricingForms(pricing) {
            // Booking prices
            if (pricing.booking) {
                const b = pricing.booking;
                if (b.customVideos) {
                    document.getElementById('price-customVideos').value = b.customVideos.basePrice || 50;
                    document.getElementById('label-customVideos').value = b.customVideos.priceLabel || 'Starting at';
                }
                if (b.liveSessions) {
                    document.getElementById('price-liveSessions').value = b.liveSessions.basePrice || 100;
                    document.getElementById('label-liveSessions').value = b.liveSessions.priceLabel || 'Per 30 min';
                }
                if (b.ratings) {
                    document.getElementById('price-ratings').value = b.ratings.basePrice || 25;
                    document.getElementById('label-ratings').value = b.ratings.priceLabel || 'Starting at';
                }
                if (b.sexting) {
                    document.getElementById('price-sexting').value = b.sexting.basePrice || 30;
                    document.getElementById('label-sexting').value = b.sexting.priceLabel || 'Per 30 min';
                }
            }

            // Subscription prices
            if (pricing.subscriptions) {
                const s = pricing.subscriptions;
                if (s.free) {
                    document.getElementById('tagline-free').value = s.free.tagline || "Just gettin' started";
                }
                if (s.silver) {
                    document.getElementById('price-silver').value = s.silver.price || 9.99;
                    document.getElementById('tagline-silver').value = s.silver.tagline || 'For the dedicated fans';
                }
                if (s.gold) {
                    document.getElementById('price-gold').value = s.gold.price || 24.99;
                    document.getElementById('discount-gold').value = s.gold.discount || 10;
                    document.getElementById('tagline-gold').value = s.gold.tagline || 'The real deal';
                }
                if (s.vip) {
                    document.getElementById('price-vip').value = s.vip.price || 49.99;
                    document.getElementById('discount-vip').value = s.vip.discount || 25;
                    document.getElementById('tagline-vip').value = s.vip.tagline || 'Top of the herd';
                }
            }
        }

        // Switch pricing tabs
        function switchPricingTab(tab) {
            document.querySelectorAll('.pricing-section-tabs button').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(tab.substring(0, 4)));
            });
            document.querySelectorAll('.pricing-subsection').forEach(section => {
                section.classList.toggle('active', section.id === `pricing-${tab}`);
            });
        }

        // Save booking prices
        async function saveBookingPrices() {
            const booking = {
                customVideos: {
                    ...currentPricing?.booking?.customVideos,
                    basePrice: parseFloat(document.getElementById('price-customVideos').value) || 50,
                    priceLabel: document.getElementById('label-customVideos').value || 'Starting at'
                },
                liveSessions: {
                    ...currentPricing?.booking?.liveSessions,
                    basePrice: parseFloat(document.getElementById('price-liveSessions').value) || 100,
                    priceLabel: document.getElementById('label-liveSessions').value || 'Per 30 min'
                },
                ratings: {
                    ...currentPricing?.booking?.ratings,
                    basePrice: parseFloat(document.getElementById('price-ratings').value) || 25,
                    priceLabel: document.getElementById('label-ratings').value || 'Starting at'
                },
                sexting: {
                    ...currentPricing?.booking?.sexting,
                    basePrice: parseFloat(document.getElementById('price-sexting').value) || 30,
                    priceLabel: document.getElementById('label-sexting').value || 'Per 30 min'
                }
            };

            try {
                const res = await fetch(`${PRICING_API}?action=save-booking`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(booking)
                });
                const data = await res.json();
                if (data.success) {
                    currentPricing.booking = data.booking;
                    showNotification('Booking prices saved!', 'success');
                } else {
                    showNotification(data.error || 'Failed to save', 'error');
                }
            } catch (err) {
                showNotification('Failed to save prices', 'error');
            }
        }

        // Save subscription prices
        async function saveSubscriptionPrices() {
            const subscriptions = {
                free: {
                    ...currentPricing?.subscriptions?.free,
                    tagline: document.getElementById('tagline-free').value
                },
                silver: {
                    ...currentPricing?.subscriptions?.silver,
                    price: parseFloat(document.getElementById('price-silver').value) || 9.99,
                    tagline: document.getElementById('tagline-silver').value
                },
                gold: {
                    ...currentPricing?.subscriptions?.gold,
                    price: parseFloat(document.getElementById('price-gold').value) || 24.99,
                    discount: parseInt(document.getElementById('discount-gold').value) || 10,
                    tagline: document.getElementById('tagline-gold').value
                },
                vip: {
                    ...currentPricing?.subscriptions?.vip,
                    price: parseFloat(document.getElementById('price-vip').value) || 49.99,
                    discount: parseInt(document.getElementById('discount-vip').value) || 25,
                    tagline: document.getElementById('tagline-vip').value
                }
            };

            try {
                const res = await fetch(`${PRICING_API}?action=save-subscriptions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(subscriptions)
                });
                const data = await res.json();
                if (data.success) {
                    currentPricing.subscriptions = data.subscriptions;
                    showNotification('Subscription prices saved!', 'success');
                } else {
                    showNotification(data.error || 'Failed to save', 'error');
                }
            } catch (err) {
                showNotification('Failed to save prices', 'error');
            }
        }

        // Reset pricing to defaults
        async function resetBookingPrices() {
            if (!confirm('Reset booking prices to defaults?')) return;
            try {
                const res = await fetch(`${PRICING_API}?action=reset`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                if (data.success) {
                    currentPricing = data.pricing;
                    populatePricingForms(data.pricing);
                    showNotification('Prices reset to defaults', 'success');
                }
            } catch (err) {
                showNotification('Reset failed', 'error');
            }
        }

        async function resetSubscriptionPrices() {
            if (!confirm('Reset subscription prices to defaults?')) return;
            try {
                const res = await fetch(`${PRICING_API}?action=reset`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                if (data.success) {
                    currentPricing = data.pricing;
                    populatePricingForms(data.pricing);
                    showNotification('Prices reset to defaults', 'success');
                }
            } catch (err) {
                showNotification('Reset failed', 'error');
            }
        }

        // Load pricing when logged in
        if (authToken) {
            loadPricing();
            loadUsers();
            loadFeatured();
        }

        // ========== FEATURED CAROUSEL MANAGEMENT ==========
        let featuredImages = [];

        async function loadFeatured() {
            try {
                const res = await fetch(`${API_BASE}?action=get-featured&_=${Date.now()}`);
                const data = await res.json();

                const container = document.getElementById('featuredAdmin');
                const emptyState = document.getElementById('featuredEmpty');
                const countEl = document.getElementById('featuredCount');

                if (data.success && data.featured && data.featured.length > 0) {
                    featuredImages = data.featured;
                    container.innerHTML = data.featured.map((img, i) => `
                        <div class="gallery-item-admin featured-item" data-url="${img.url}" data-order="${i}" style="aspect-ratio: 16/9;">
                            <img src="${img.url}" alt="${img.altText || img.title || ''}" loading="lazy">
                            <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 8px; background: rgba(0,0,0,0.85);">
                                <div style="font-size: 0.9rem; font-weight: 600; color: var(--whiskey);">${img.title || '(No title)'}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${img.caption || ''}</div>
                                ${img.link ? `<div style="font-size: 0.7rem; color: #4CAF50; margin-top: 4px;">Link: ${img.link}</div>` : ''}
                            </div>
                            <button class="delete-btn" onclick="deleteFeatured('${img.url}')">&times;</button>
                            <div style="position: absolute; top: 8px; left: 8px; background: var(--whiskey); color: black; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">#${i + 1}</div>
                            ${img.link ? '<div style="position: absolute; top: 8px; right: 40px; background: #4CAF50; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem;">HAS LINK</div>' : ''}
                        </div>
                    `).join('');
                    emptyState.style.display = 'none';
                    countEl.textContent = data.featured.length;
                } else {
                    featuredImages = [];
                    container.innerHTML = '';
                    emptyState.style.display = 'block';
                    countEl.textContent = '0';
                }
            } catch (err) {
                console.error('Failed to load featured:', err);
            }
        }

        // Featured upload handlers
        const featuredInputs = [
            document.getElementById('featuredUpload'),
            document.getElementById('featuredBulkUpload')
        ];

        featuredInputs.forEach(input => {
            if (input) {
                input.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const title = document.getElementById('featuredTitle').value;
                    const caption = document.getElementById('featuredCaption').value;
                    const link = document.getElementById('featuredLink').value;
                    const linkText = document.getElementById('featuredLinkText').value;
                    const altText = document.getElementById('featuredAltText').value;

                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('title', title);
                    formData.append('caption', caption);
                    formData.append('link', link);
                    formData.append('linkText', linkText);
                    formData.append('altText', altText);

                    try {
                        const res = await fetch(`${API_BASE}?action=upload-featured&token=${authToken}`, {
                            method: 'POST',
                            body: formData
                        });

                        const data = await res.json();
                        if (data.success) {
                            showNotification('Featured photo uploaded!', 'success');
                            document.getElementById('featuredTitle').value = '';
                            document.getElementById('featuredCaption').value = '';
                            document.getElementById('featuredLink').value = '';
                            document.getElementById('featuredLinkText').value = '';
                            document.getElementById('featuredAltText').value = '';
                            loadFeatured();
                        } else {
                            showNotification(data.error || 'Upload failed', 'error');
                        }
                    } catch (err) {
                        showNotification('Upload failed', 'error');
                    }

                    e.target.value = '';
                });
            }
        });

        async function deleteFeatured(url) {
            if (!confirm('Remove this photo from the featured carousel?')) return;

            try {
                const res = await fetch(`${API_BASE}?action=delete-featured&token=${authToken}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                const data = await res.json();
                if (data.success) {
                    showNotification('Photo removed from carousel', 'success');
                    loadFeatured();
                } else {
                    showNotification(data.error || 'Delete failed', 'error');
                }
            } catch (err) {
                showNotification('Delete failed', 'error');
            }
        }

        async function saveFeaturedOrder() {
            // Get current order from DOM
            const items = document.querySelectorAll('.featured-item');
            const featured = [];

            items.forEach((item, index) => {
                const url = item.dataset.url;
                const existing = featuredImages.find(f => f.url === url);
                if (existing) {
                    featured.push({
                        ...existing,
                        order: index
                    });
                }
            });

            try {
                const res = await fetch(`${API_BASE}?action=save-featured&token=${authToken}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ featured })
                });

                const data = await res.json();
                if (data.success) {
                    showNotification('Order saved!', 'success');
                    loadFeatured();
                } else {
                    showNotification(data.error || 'Save failed', 'error');
                }
            } catch (err) {
                showNotification('Save failed', 'error');
            }
        }

        // ========== USER MANAGEMENT ==========
        const WORLD_API = 'api/world.php';

        async function loadUsers() {
            try {
                const res = await fetch(`${WORLD_API}?action=list-users`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();

                if (data.success) {
                    renderUsersTable(data.users);
                    updateUserStats(data.users);
                } else {
                    document.getElementById('usersTable').innerHTML =
                        '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">Failed to load users</td></tr>';
                }
            } catch (err) {
                console.error('Failed to load users:', err);
                document.getElementById('usersTable').innerHTML =
                    '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">Error loading users</td></tr>';
            }
        }

        function updateUserStats(users) {
            const total = users.length;
            const active = users.filter(u => u.status === 'active').length;
            const pending = users.filter(u => u.status === 'pending' || !u.emailVerified).length;
            const banned = users.filter(u => u.status === 'banned').length;

            document.getElementById('stat-total-users').textContent = total;
            document.getElementById('stat-active-users').textContent = active;
            document.getElementById('stat-pending-users').textContent = pending;
            document.getElementById('stat-banned-users').textContent = banned;
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTable');

            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">No users yet</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => {
                const statusClass = user.status === 'active' ? 'status--completed' :
                                   user.status === 'banned' ? 'status--cancelled' : 'status--pending';
                const verifiedIcon = user.emailVerified ? '‚úì' : '‚úï';
                const verifiedColor = user.emailVerified ? '#4CAF50' : 'var(--rust)';
                const joinDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A';

                let actions = '';
                if (user.status === 'pending' || !user.emailVerified) {
                    actions += `<button class="action-btn" onclick="approveUser('${user.id}')">Approve</button> `;
                }
                if (user.status !== 'banned') {
                    actions += `<button class="action-btn action-btn--danger" onclick="banUser('${user.id}')">Ban</button> `;
                } else {
                    actions += `<button class="action-btn" onclick="unbanUser('${user.id}')">Unban</button> `;
                }
                actions += `<button class="action-btn action-btn--danger" onclick="deleteUser('${user.id}')">Delete</button>`;

                return `
                    <tr data-user-id="${user.id}">
                        <td><strong>${user.username}</strong></td>
                        <td>${user.email}</td>
                        <td>
                            <select onchange="updateUserTier('${user.id}', this.value)" style="background: var(--bg-card); color: var(--text-primary); border: 1px solid rgba(198,142,63,0.3); padding: 4px 8px; border-radius: 4px;">
                                <option value="free" ${user.tier === 'free' ? 'selected' : ''}>Free</option>
                                <option value="silver" ${user.tier === 'silver' ? 'selected' : ''}>Silver</option>
                                <option value="gold" ${user.tier === 'gold' ? 'selected' : ''}>Gold</option>
                                <option value="vip" ${user.tier === 'vip' ? 'selected' : ''}>VIP</option>
                            </select>
                        </td>
                        <td><span class="status ${statusClass}">${user.status}</span></td>
                        <td style="color: ${verifiedColor}; font-weight: bold;">${verifiedIcon}</td>
                        <td>${joinDate}</td>
                        <td>${actions}</td>
                    </tr>
                `;
            }).join('');
        }

        async function approveUser(userId) {
            try {
                const res = await fetch(`${WORLD_API}?action=approve-user`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ id: userId })
                });
                const data = await res.json();
                if (data.success) {
                    showNotification('User approved!', 'success');
                    loadUsers();
                } else {
                    showNotification(data.error || 'Failed to approve', 'error');
                }
            } catch (err) {
                showNotification('Error approving user', 'error');
            }
        }

        async function banUser(userId) {
            const reason = prompt('Ban reason (optional):');
            if (reason === null) return; // Cancelled

            try {
                const res = await fetch(`${WORLD_API}?action=ban-user`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ id: userId, reason: reason || 'Violated terms of service' })
                });
                const data = await res.json();
                if (data.success) {
                    showNotification('User banned', 'success');
                    loadUsers();
                } else {
                    showNotification(data.error || 'Failed to ban', 'error');
                }
            } catch (err) {
                showNotification('Error banning user', 'error');
            }
        }

        async function unbanUser(userId) {
            if (!confirm('Unban this user?')) return;

            try {
                const res = await fetch(`${WORLD_API}?action=unban-user`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ id: userId })
                });
                const data = await res.json();
                if (data.success) {
                    showNotification('User unbanned', 'success');
                    loadUsers();
                } else {
                    showNotification(data.error || 'Failed to unban', 'error');
                }
            } catch (err) {
                showNotification('Error unbanning user', 'error');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Permanently delete this user? This cannot be undone.')) return;

            try {
                const res = await fetch(`${WORLD_API}?action=delete-user`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ id: userId })
                });
                const data = await res.json();
                if (data.success) {
                    showNotification('User deleted', 'success');
                    loadUsers();
                } else {
                    showNotification(data.error || 'Failed to delete', 'error');
                }
            } catch (err) {
                showNotification('Error deleting user', 'error');
            }
        }

        async function updateUserTier(userId, tier) {
            try {
                const res = await fetch(`${WORLD_API}?action=update-user`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ id: userId, tier: tier })
                });
                const data = await res.json();
                if (data.success) {
                    showNotification('Tier updated', 'success');
                } else {
                    showNotification(data.error || 'Failed to update', 'error');
                    loadUsers(); // Reload to reset dropdown
                }
            } catch (err) {
                showNotification('Error updating tier', 'error');
                loadUsers();
            }
        }

        // ============ WORLD USERS FUNCTIONS ============

        async function loadWorldUsers() {
            try {
                const res = await fetch(`${WORLD_API}?action=list-users&token=${authToken}`);
                const data = await res.json();

                if (data.success && data.users) {
                    const users = data.users;

                    // Update stats
                    document.getElementById('totalWorldUsers').textContent = users.length;
                    document.getElementById('adminUsers').textContent = users.filter(u => u.tier === 'admin').length;
                    document.getElementById('activeUsers').textContent = users.filter(u => u.status === 'active').length;

                    // Render table
                    const tbody = document.getElementById('worldUsersTable');
                    if (users.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No users yet</td></tr>';
                        return;
                    }

                    tbody.innerHTML = users.map(user => `
                        <tr>
                            <td><strong>${user.username}</strong></td>
                            <td>${user.email}</td>
                            <td>
                                <select onchange="updateWorldUserTier('${user.id}', this.value)" class="tier-select tier-${user.tier || 'free'}">
                                    <option value="free" ${user.tier === 'free' || !user.tier ? 'selected' : ''}>Free</option>
                                    <option value="admin" ${user.tier === 'admin' ? 'selected' : ''}>Admin</option>
                                </select>
                            </td>
                            <td>
                                <span class="status-badge status-${user.status || 'pending'}">${user.status || 'pending'}</span>
                            </td>
                            <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                            <td>
                                ${user.status === 'pending' ? `<button class="btn btn--sm btn--primary" onclick="approveWorldUser('${user.id}')">Approve</button>` : ''}
                                ${user.status !== 'banned' ? `<button class="btn btn--sm btn--outline" onclick="banWorldUser('${user.id}')">Ban</button>` : `<button class="btn btn--sm btn--outline" onclick="unbanWorldUser('${user.id}')">Unban</button>`}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    showNotification(data.error || 'Failed to load users', 'error');
                }
            } catch (err) {
                console.error('Failed to load world users:', err);
                document.getElementById('worldUsersTable').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #ef4444;">Error loading users</td></tr>';
            }
        }

        async function updateWorldUserTier(userId, tier) {
            try {
                const res = await fetch(`${WORLD_API}?action=update-tier&token=${authToken}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: userId, tier })
                });
                const data = await res.json();

                if (data.success) {
                    showNotification(`User tier updated to ${tier.toUpperCase()}`, 'success');
                    loadWorldUsers();
                } else {
                    showNotification(data.error || 'Update failed', 'error');
                    loadWorldUsers();
                }
            } catch (err) {
                showNotification('Error updating tier', 'error');
                loadWorldUsers();
            }
        }

        async function approveWorldUser(userId) {
            try {
                const res = await fetch(`${WORLD_API}?action=approve-user&token=${authToken}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: userId })
                });
                const data = await res.json();

                if (data.success) {
                    showNotification('User approved', 'success');
                    loadWorldUsers();
                } else {
                    showNotification(data.error || 'Approval failed', 'error');
                }
            } catch (err) {
                showNotification('Error approving user', 'error');
            }
        }

        async function banWorldUser(userId) {
            const reason = prompt('Ban reason (optional):');
            try {
                const res = await fetch(`${WORLD_API}?action=ban-user&token=${authToken}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: userId, reason })
                });
                const data = await res.json();

                if (data.success) {
                    showNotification('User banned', 'success');
                    loadWorldUsers();
                } else {
                    showNotification(data.error || 'Ban failed', 'error');
                }
            } catch (err) {
                showNotification('Error banning user', 'error');
            }
        }

        async function unbanWorldUser(userId) {
            try {
                const res = await fetch(`${WORLD_API}?action=unban-user&token=${authToken}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: userId })
                });
                const data = await res.json();

                if (data.success) {
                    showNotification('User unbanned', 'success');
                    loadWorldUsers();
                } else {
                    showNotification(data.error || 'Unban failed', 'error');
                }
            } catch (err) {
                showNotification('Error unbanning user', 'error');
            }
        }

        // ============ SOCIAL LINKS MANAGEMENT ============

        const socialPlatforms = [
            'twitter', 'instagram', 'bluesky', 'tiktok', 'onlyfans',
            'fansly', 'boyfanz', 'youtube', 'threads', 'snapchat', 'discord', 'telegram'
        ];

        async function loadSocialLinks() {
            try {
                const res = await fetch(`${API_BASE}?action=get-socials`);
                const data = await res.json();

                if (data.success && data.socials) {
                    socialPlatforms.forEach(platform => {
                        const input = document.getElementById(`social${platform.charAt(0).toUpperCase() + platform.slice(1)}`);
                        if (input && data.socials[platform]) {
                            input.value = data.socials[platform];
                        }
                    });
                }
            } catch (err) {
                console.error('Failed to load social links:', err);
            }
        }

        document.getElementById('socialSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const socials = {};
            socialPlatforms.forEach(platform => {
                const input = document.getElementById(`social${platform.charAt(0).toUpperCase() + platform.slice(1)}`);
                if (input && input.value.trim()) {
                    socials[platform] = input.value.trim();
                }
            });

            try {
                const res = await fetch(`${API_BASE}?action=save-socials&token=${authToken}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(socials)
                });

                const data = await res.json();
                if (data.success) {
                    showNotification('Social links saved!', 'success');
                } else {
                    showNotification(data.error || 'Save failed', 'error');
                }
            } catch (err) {
                showNotification('Failed to save social links', 'error');
            }
        });

        // Load social links on init
        if (authToken) {
            loadSocialLinks();
            loadIntegrations();
        }

        // ============ INTEGRATION FUNCTIONS ============

        function showIntTab(tabId) {
            document.querySelectorAll('.int-tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.int-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('int-tab-' + tabId).classList.add('active');
            event.target.classList.add('active');
        }

        async function loadIntegrations() {
            try {
                const res = await fetch(`${API_BASE}?action=get-integrations&token=${authToken}`);
                const data = await res.json();
                if (data.success && data.integrations) {
                    Object.keys(data.integrations).forEach(vendor => {
                        const config = data.integrations[vendor];
                        Object.keys(config).forEach(key => {
                            const input = document.getElementById(`${vendor}-${key}`);
                            if (input) input.value = config[key];
                        });
                        // Update status
                        const statusEl = document.getElementById(`status-${vendor}`);
                        if (statusEl && config.connected) {
                            statusEl.textContent = 'Connected';
                            statusEl.className = 'status-badge connected';
                        }
                    });
                }
            } catch (err) {
                console.error('Failed to load integrations:', err);
            }
        }

        async function testIntegration(vendor) {
            const statusEl = document.getElementById(`status-${vendor}`);
            statusEl.textContent = 'Testing...';
            statusEl.className = 'status-badge';

            try {
                const res = await fetch(`${API_BASE}?action=test-integration&vendor=${vendor}&token=${authToken}`);
                const data = await res.json();

                if (data.success) {
                    statusEl.textContent = 'Connected';
                    statusEl.className = 'status-badge connected';
                    showNotification(`${vendor} connection successful!`, 'success');
                } else {
                    statusEl.textContent = 'Failed';
                    statusEl.className = 'status-badge disconnected';
                    showNotification(data.error || 'Connection failed', 'error');
                }
            } catch (err) {
                statusEl.textContent = 'Error';
                statusEl.className = 'status-badge disconnected';
                showNotification('Test failed', 'error');
            }
        }

        async function saveIntegration(vendor) {
            const card = document.getElementById(`status-${vendor}`).closest('.vendor-card');
            const inputs = card.querySelectorAll('input');
            const config = {};

            inputs.forEach(input => {
                const key = input.id.replace(`${vendor}-`, '');
                if (input.value.trim()) {
                    config[key] = input.value.trim();
                }
            });

            try {
                const res = await fetch(`${API_BASE}?action=save-integration&token=${authToken}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vendor, config })
                });

                const data = await res.json();
                if (data.success) {
                    showNotification(`${vendor} settings saved!`, 'success');
                } else {
                    showNotification(data.error || 'Save failed', 'error');
                }
            } catch (err) {
                // Save to localStorage as fallback
                localStorage.setItem(`integration_${vendor}`, JSON.stringify(config));
                showNotification(`${vendor} saved locally`, 'success');
            }
        }

        function saveAllIntegrations() {
            showNotification('Saving all integration settings...', 'info');
            document.querySelectorAll('.vendor-card').forEach(card => {
                const saveBtn = card.querySelector('[onclick^="saveIntegration"]');
                if (saveBtn) saveBtn.click();
            });
        }

        // ============ VERIFICATION FLOW ============
        let pendingChallengeId = null;

        // Update login handler to support verification flow
        document.getElementById('adminLoginForm').removeEventListener('submit', () => {});
        document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const res = await fetch(`${API_BASE}?action=login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await res.json();

                if (data.success && data.token) {
                    // Direct login (trusted IP)
                    authToken = data.token;
                    localStorage.setItem('adminToken', authToken);
                    localStorage.setItem('wyatt_admin_auth', JSON.stringify({
                        token: authToken,
                        expires: Date.now() + (24 * 60 * 60 * 1000),
                        loggedIn: true
                    }));
                    showDashboard();
                    loadAllDashboardData();
                    showNotification('Welcome back!', 'success');
                } else if (data.requiresVerification && data.challengeId) {
                    // New IP - show verification form
                    pendingChallengeId = data.challengeId;
                    document.getElementById('adminLoginForm').style.display = 'none';
                    document.getElementById('verifyForm').style.display = 'block';
                    showNotification('Verification code sent to admin email', 'success');
                } else {
                    showNotification(data.error || 'Login failed', 'error');
                }
            } catch (err) {
                console.error('Login error:', err);
                showNotification('Login failed. Check your connection.', 'error');
            }
        });

        // Verify button handler
        document.getElementById('verifyBtn').addEventListener('click', async () => {
            const code = document.getElementById('verifyCode').value.trim();
            if (!code || code.length !== 6) {
                showNotification('Enter a 6-digit code', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}?action=verify-login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        challengeId: pendingChallengeId,
                        code: code
                    })
                });

                const data = await res.json();

                if (data.success && data.token) {
                    authToken = data.token;
                    localStorage.setItem('adminToken', authToken);
                    localStorage.setItem('wyatt_admin_auth', JSON.stringify({
                        token: authToken,
                        expires: Date.now() + (24 * 60 * 60 * 1000),
                        loggedIn: true
                    }));
                    showDashboard();
                    loadAllDashboardData();
                    showNotification('Verified! Welcome back.', 'success');
                } else {
                    showNotification(data.error || 'Verification failed', 'error');
                }
            } catch (err) {
                showNotification('Verification failed', 'error');
            }
        });

        // Back to login button
        document.getElementById('backToLogin').addEventListener('click', () => {
            pendingChallengeId = null;
            document.getElementById('verifyCode').value = '';
            document.getElementById('verifyForm').style.display = 'none';
            document.getElementById('adminLoginForm').style.display = 'block';
        });

        // ============ DASHBOARD DATA LOADING ============
        // Main loadAllDashboardData() is defined at the bottom with all functions

        async function loadDashboardStats() {
            try {
                const res = await fetch(`${API_BASE}?action=dashboard&token=${authToken}`);
                const data = await res.json();

                if (data.success) {
                    document.getElementById('stat-subscribers').textContent = data.stats.activeSubscribers || 0;
                    document.getElementById('stat-requests-new').textContent = data.stats.newRequests || 0;
                    document.getElementById('stat-requests-total').textContent = data.stats.totalRequests || 0;
                    document.getElementById('stat-clicks').textContent = data.stats.recentClicks || 0;
                }
            } catch (err) {
                console.error('Failed to load dashboard stats:', err);
            }
        }

        async function loadSystemHealth() {
            try {
                const res = await fetch(`${API_BASE}?action=system-health&token=${authToken}`);
                const data = await res.json();

                if (data.success && data.health) {
                    const h = data.health;

                    // Database
                    const dbDot = document.getElementById('health-db');
                    dbDot.className = 'health-dot ' + (h.database ? 'healthy' : 'error');

                    // File uploads
                    const uploadsDot = document.getElementById('health-uploads');
                    uploadsDot.className = 'health-dot ' + (h.uploadsDir ? 'healthy' : 'error');

                    // SMTP
                    const smtpDot = document.getElementById('health-smtp');
                    smtpDot.className = 'health-dot ' + (h.smtpConfigured ? 'healthy' : 'warning');
                }
            } catch (err) {
                console.error('Failed to load system health:', err);
            }
        }

        // ============ REQUESTS MANAGEMENT ============
        let allRequests = [];

        async function loadRequests() {
            const filter = document.getElementById('requestFilter')?.value || '';

            try {
                const res = await fetch(`${API_BASE}?action=list-requests&status=${filter}&token=${authToken}`);
                const data = await res.json();

                const tbody = document.getElementById('requestsBody');

                if (data.success && data.requests && data.requests.length > 0) {
                    allRequests = data.requests;
                    tbody.innerHTML = data.requests.map(req => {
                        const statusClass = getStatusClass(req.status);
                        const date = new Date(req.created_at).toLocaleDateString();
                        const price = req.price ? `$${parseFloat(req.price).toFixed(2)}` : '-';

                        return `
                            <tr data-request-id="${req.id}">
                                <td>${date}</td>
                                <td><strong>${escapeHtml(req.name)}</strong></td>
                                <td>${escapeHtml(req.email)}</td>
                                <td>${formatRequestType(req.request_type)}</td>
                                <td>
                                    <select onchange="updateRequestStatus(${req.id}, this.value)" class="tier-select">
                                        <option value="new" ${req.status === 'new' ? 'selected' : ''}>New</option>
                                        <option value="reviewed" ${req.status === 'reviewed' ? 'selected' : ''}>Reviewed</option>
                                        <option value="approved" ${req.status === 'approved' ? 'selected' : ''}>Approved</option>
                                        <option value="in_progress" ${req.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="delivered" ${req.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                        <option value="cancelled" ${req.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                </td>
                                <td>${price}</td>
                                <td>
                                    <button class="action-btn" onclick="viewRequest(${req.id})">View</button>
                                    <button class="action-btn" onclick="setRequestPrice(${req.id})">Set Price</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No requests found</td></tr>';
                }
            } catch (err) {
                console.error('Failed to load requests:', err);
                document.getElementById('requestsBody').innerHTML = '<tr><td colspan="7" class="empty-state">Error loading requests</td></tr>';
            }
        }

        function getStatusClass(status) {
            switch(status) {
                case 'new': return 'status--pending';
                case 'delivered': return 'status--completed';
                case 'cancelled': return 'status--cancelled';
                default: return 'status--pending';
            }
        }

        function formatRequestType(type) {
            const types = {
                'custom_video': 'Custom Video',
                'custom_photos': 'Custom Photos',
                'live_session': 'Live Session',
                'sexting': 'Sexting',
                'other': 'Other'
            };
            return types[type] || type;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function updateRequestStatus(requestId, status) {
            try {
                const res = await fetch(`${API_BASE}?action=update-request&token=${authToken}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: requestId, status })
                });

                const data = await res.json();
                if (data.success) {
                    showNotification('Status updated', 'success');
                    loadRequests();
                    loadDashboardStats();
                } else {
                    showNotification(data.error || 'Update failed', 'error');
                }
            } catch (err) {
                showNotification('Error updating status', 'error');
            }
        }

        function setRequestPrice(requestId) {
            const price = prompt('Enter price (e.g., 50.00):');
            if (price === null) return;

            const priceNum = parseFloat(price);
            if (isNaN(priceNum) || priceNum < 0) {
                showNotification('Invalid price', 'error');
                return;
            }

            updateRequestField(requestId, 'price', priceNum);
        }

        async function updateRequestField(requestId, field, value) {
            try {
                const res = await fetch(`${API_BASE}?action=update-request&token=${authToken}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: requestId, [field]: value })
                });

                const data = await res.json();
                if (data.success) {
                    showNotification('Request updated', 'success');
                    loadRequests();
                } else {
                    showNotification(data.error || 'Update failed', 'error');
                }
            } catch (err) {
                showNotification('Error updating request', 'error');
            }
        }

        function viewRequest(requestId) {
            const req = allRequests.find(r => r.id == requestId);
            if (!req) return;

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Request #${req.id}</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                    </div>
                    <div style="display: grid; gap: var(--space-md);">
                        <div><strong>Name:</strong> ${escapeHtml(req.name)}</div>
                        <div><strong>Email:</strong> ${escapeHtml(req.email)}</div>
                        <div><strong>Type:</strong> ${formatRequestType(req.request_type)}</div>
                        <div><strong>Status:</strong> ${req.status}</div>
                        <div><strong>Price:</strong> ${req.price ? '$' + parseFloat(req.price).toFixed(2) : 'Not set'}</div>
                        <div><strong>Submitted:</strong> ${new Date(req.created_at).toLocaleString()}</div>
                        ${req.duration ? `<div><strong>Duration:</strong> ${escapeHtml(req.duration)}</div>` : ''}
                        ${req.contact_method ? `<div><strong>Contact Method:</strong> ${escapeHtml(req.contact_method)}</div>` : ''}
                        <div style="margin-top: var(--space-md);">
                            <strong>Details:</strong>
                            <p style="margin-top: var(--space-xs); padding: var(--space-md); background: var(--bg-secondary); border-radius: var(--radius-sm);">
                                ${escapeHtml(req.details || 'No details provided')}
                            </p>
                        </div>
                        ${req.preferences ? `
                        <div>
                            <strong>Preferences:</strong>
                            <p style="margin-top: var(--space-xs); padding: var(--space-md); background: var(--bg-secondary); border-radius: var(--radius-sm);">
                                ${escapeHtml(req.preferences)}
                            </p>
                        </div>` : ''}
                        ${req.limits ? `
                        <div>
                            <strong>Limits:</strong>
                            <p style="margin-top: var(--space-xs); padding: var(--space-md); background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-sm); border: 1px solid rgba(239, 68, 68, 0.3);">
                                ${escapeHtml(req.limits)}
                            </p>
                        </div>` : ''}
                        ${req.admin_notes ? `
                        <div>
                            <strong>Admin Notes:</strong>
                            <p style="margin-top: var(--space-xs); padding: var(--space-md); background: rgba(198, 142, 63, 0.1); border-radius: var(--radius-sm);">
                                ${escapeHtml(req.admin_notes)}
                            </p>
                        </div>` : ''}
                    </div>
                    <div style="margin-top: var(--space-xl); display: flex; gap: var(--space-md);">
                        <button class="btn btn--secondary" onclick="addAdminNote(${req.id})">Add Note</button>
                        <button class="btn btn--primary" onclick="this.closest('.modal-overlay').remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function addAdminNote(requestId) {
            const note = prompt('Add admin note:');
            if (note) {
                updateRequestField(requestId, 'admin_notes', note);
                document.querySelector('.modal-overlay')?.remove();
            }
        }

        // ============ SUBSCRIBERS MANAGEMENT ============
        async function loadSubscribers() {
            try {
                const res = await fetch(`${API_BASE}?action=list-subscribers&token=${authToken}`);
                const data = await res.json();

                const tbody = document.getElementById('subscribersBody');
                const totalEl = document.getElementById('total-subscribers');

                if (data.success && data.subscribers && data.subscribers.length > 0) {
                    totalEl.textContent = data.subscribers.filter(s => s.is_active).length;

                    tbody.innerHTML = data.subscribers.map(sub => {
                        const date = new Date(sub.subscribed_at).toLocaleDateString();
                        const statusClass = sub.is_active ? 'status--completed' : 'status--cancelled';
                        const statusText = sub.is_active ? 'Active' : 'Unsubscribed';

                        return `
                            <tr>
                                <td>${escapeHtml(sub.email)}</td>
                                <td>${escapeHtml(sub.source || 'footer')}</td>
                                <td>${date}</td>
                                <td><span class="status ${statusClass}">${statusText}</span></td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    totalEl.textContent = '0';
                    tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No subscribers yet</td></tr>';
                }
            } catch (err) {
                console.error('Failed to load subscribers:', err);
            }
        }

        async function exportSubscribers() {
            try {
                const res = await fetch(`${API_BASE}?action=export-subscribers&token=${authToken}`);
                const data = await res.json();

                if (data.success && data.csv) {
                    // Create download
                    const blob = new Blob([data.csv], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `subscribers_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showNotification('CSV downloaded!', 'success');
                } else {
                    showNotification(data.error || 'Export failed', 'error');
                }
            } catch (err) {
                showNotification('Export failed', 'error');
            }
        }

        // ============ ANALYTICS ============
        async function loadAnalytics() {
            const days = document.getElementById('analyticsDays')?.value || 7;

            try {
                const res = await fetch(`${API_BASE}?action=get-analytics&days=${days}&token=${authToken}`);
                const data = await res.json();

                const totalEl = document.getElementById('analytics-total');
                const chartEl = document.getElementById('analyticsChart');

                if (data.success && data.analytics) {
                    const total = data.analytics.reduce((sum, a) => sum + parseInt(a.clicks || 0), 0);
                    totalEl.textContent = total;

                    if (data.analytics.length > 0) {
                        const maxClicks = Math.max(...data.analytics.map(a => parseInt(a.clicks || 0)));

                        chartEl.innerHTML = data.analytics.map(a => {
                            const clicks = parseInt(a.clicks || 0);
                            const percentage = maxClicks > 0 ? (clicks / maxClicks * 100) : 0;

                            return `
                                <div class="analytics-bar">
                                    <span class="analytics-bar__label">${escapeHtml(a.platform)}</span>
                                    <div class="analytics-bar__track">
                                        <div class="analytics-bar__fill" style="width: ${percentage}%">
                                            ${percentage > 20 ? clicks : ''}
                                        </div>
                                    </div>
                                    <span class="analytics-bar__count">${clicks}</span>
                                </div>
                            `;
                        }).join('');
                    } else {
                        chartEl.innerHTML = '<p style="color: var(--text-muted);">No analytics data for this period</p>';
                    }
                } else {
                    totalEl.textContent = '0';
                    chartEl.innerHTML = '<p style="color: var(--text-muted);">No analytics data available</p>';
                }
            } catch (err) {
                console.error('Failed to load analytics:', err);
            }
        }

        // ============ SECURITY LOGS ============
        async function loadLoginLogs() {
            try {
                const res = await fetch(`${API_BASE}?action=login-logs&limit=50&token=${authToken}`);
                const data = await res.json();

                const tbody = document.getElementById('loginLogsBody');

                if (data.success && data.logs && data.logs.length > 0) {
                    tbody.innerHTML = data.logs.map(log => {
                        const time = new Date(log.created_at).toLocaleString();
                        const statusClass = log.success ? 'status--completed' : 'status--cancelled';
                        const statusText = log.success ? 'Success' : 'Failed';

                        return `
                            <tr>
                                <td>${time}</td>
                                <td>${escapeHtml(log.admin_username || 'unknown')}</td>
                                <td>${escapeHtml(log.ip_address)}</td>
                                <td><span class="status ${statusClass}">${statusText}</span></td>
                                <td>${escapeHtml(log.reason || '-')}</td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No login logs yet</td></tr>';
                }
            } catch (err) {
                console.error('Failed to load login logs:', err);
            }
        }

        // ============ SMTP SETTINGS ============
        async function loadSmtpSettings() {
            try {
                const res = await fetch(`${API_BASE}?action=get-smtp-settings&token=${authToken}`);
                const data = await res.json();

                if (data.success && data.smtp) {
                    document.getElementById('smtpHost').value = data.smtp.host || '';
                    document.getElementById('smtpPort').value = data.smtp.port || 587;
                    document.getElementById('smtpUser').value = data.smtp.user || '';
                    document.getElementById('smtpFromEmail').value = data.smtp.fromEmail || '';
                    document.getElementById('smtpFromName').value = data.smtp.fromName || '';
                    // Don't populate password for security
                }
                if (data.adminEmail) {
                    document.getElementById('adminEmail').value = data.adminEmail;
                }
            } catch (err) {
                console.error('Failed to load SMTP settings:', err);
            }
        }

        document.getElementById('smtpSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const smtp = {
                host: document.getElementById('smtpHost').value,
                port: parseInt(document.getElementById('smtpPort').value) || 587,
                user: document.getElementById('smtpUser').value,
                pass: document.getElementById('smtpPass').value,
                fromEmail: document.getElementById('smtpFromEmail').value,
                fromName: document.getElementById('smtpFromName').value
            };

            try {
                const res = await fetch(`${API_BASE}?action=save-smtp-settings&token=${authToken}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(smtp)
                });

                const data = await res.json();
                if (data.success) {
                    showNotification('SMTP settings saved!', 'success');
                    loadSystemHealth();
                } else {
                    showNotification(data.error || 'Save failed', 'error');
                }
            } catch (err) {
                showNotification('Failed to save SMTP settings', 'error');
            }
        });

        async function testSmtp() {
            showNotification('Testing SMTP connection...', 'info');

            try {
                const res = await fetch(`${API_BASE}?action=test-smtp&token=${authToken}`);
                const data = await res.json();

                if (data.success) {
                    showNotification('SMTP test successful! Check your admin email.', 'success');
                } else {
                    showNotification(data.error || 'SMTP test failed', 'error');
                }
            } catch (err) {
                showNotification('SMTP test failed', 'error');
            }
        }

        document.getElementById('adminEmailForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('adminEmail').value;

            try {
                const res = await fetch(`${API_BASE}?action=save-admin-email&token=${authToken}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await res.json();
                if (data.success) {
                    showNotification('Admin email saved!', 'success');
                } else {
                    showNotification(data.error || 'Save failed', 'error');
                }
            } catch (err) {
                showNotification('Failed to save admin email', 'error');
            }
        });

        // ============ EMAIL TEMPLATES SYSTEM ============
        let emailTemplates = {};
        let currentTemplateKey = '';
        let currentTemplateFilter = 'all';

        async function loadEmailTemplates() {
            try {
                const res = await fetch(`${API_BASE}?action=get-email-templates&token=${authToken}`);
                const data = await res.json();

                if (data.success && data.templates) {
                    emailTemplates = data.templates;
                    populateTemplateSelector();
                }
            } catch (err) {
                console.error('Failed to load email templates:', err);
            }
        }

        function populateTemplateSelector() {
            const selector = document.getElementById('templateSelector');
            selector.innerHTML = '<option value="">-- Choose a template --</option>';

            Object.entries(emailTemplates).forEach(([key, template]) => {
                if (currentTemplateFilter === 'all' || template.category === currentTemplateFilter) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = template.name || key;
                    option.dataset.category = template.category || 'custom';
                    selector.appendChild(option);
                }
            });
        }

        function filterTemplates(category) {
            currentTemplateFilter = category;

            // Update tab styles
            document.querySelectorAll('.template-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.category === category);
            });

            populateTemplateSelector();
            document.getElementById('templateEditor').style.display = 'none';
            currentTemplateKey = '';
        }

        function loadSelectedTemplate() {
            const selector = document.getElementById('templateSelector');
            const key = selector.value;

            if (!key || !emailTemplates[key]) {
                document.getElementById('templateEditor').style.display = 'none';
                return;
            }

            currentTemplateKey = key;
            const template = emailTemplates[key];

            document.getElementById('templateName').textContent = template.name || key;
            document.getElementById('templateCategory').textContent = template.category || 'custom';
            document.getElementById('templateSubject').value = template.subject || '';
            document.getElementById('templateBody').value = template.body || '';

            document.getElementById('templateEditor').style.display = 'block';
        }

        function insertVariable(variable) {
            const textarea = document.getElementById('templateBody');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;

            textarea.value = text.substring(0, start) + variable + text.substring(end);
            textarea.focus();
            textarea.selectionStart = textarea.selectionEnd = start + variable.length;
        }

        function previewTemplate() {
            const subject = document.getElementById('templateSubject').value;
            const body = document.getElementById('templateBody').value;

            // Replace variables with sample data
            const sampleData = {
                '{{NAME}}': 'John',
                '{{BRAND_NAME}}': 'WYATT XXX COLE',
                '{{TAGLINE}}': 'Country Bred. Fully Loaded.',
                '{{CODE}}': '847293',
                '{{UNSUBSCRIBE_LINK}}': '[Unsubscribe]',
                '{{DATE}}': new Date().toLocaleDateString(),
                '{{DISCOUNT}}': '25',
                '{{HOURS}}': '24',
                '{{PROMO_CODE}}': 'YEEHAW25',
                '{{CONTENT_TITLE}}': 'New Video Drop',
                '{{TIER_NAME}}': 'Gold Buckle',
                '{{DAYS}}': '3'
            };

            let previewSubject = subject;
            let previewBody = body;

            Object.entries(sampleData).forEach(([key, value]) => {
                previewSubject = previewSubject.split(key).join(value);
                previewBody = previewBody.split(key).join(value);
            });

            document.getElementById('previewSubject').textContent = previewSubject;
            document.getElementById('previewBody').textContent = previewBody;
            document.getElementById('templatePreviewModal').style.display = 'block';
        }

        function closeTemplatePreview() {
            document.getElementById('templatePreviewModal').style.display = 'none';
        }

        async function saveCurrentTemplate() {
            if (!currentTemplateKey) {
                showNotification('No template selected', 'error');
                return;
            }

            const template = {
                ...emailTemplates[currentTemplateKey],
                subject: document.getElementById('templateSubject').value,
                body: document.getElementById('templateBody').value
            };

            try {
                const res = await fetch(`${API_BASE}?action=save-email-templates&token=${authToken}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [currentTemplateKey]: template })
                });

                const data = await res.json();
                if (data.success) {
                    emailTemplates[currentTemplateKey] = template;
                    showNotification('Template saved!', 'success');
                } else {
                    showNotification(data.error || 'Save failed', 'error');
                }
            } catch (err) {
                showNotification('Failed to save template', 'error');
            }
        }

        // Legacy function for backwards compatibility
        async function saveEmailTemplates() {
            await saveCurrentTemplate();
        }

        // ============ GOOGLE ANALYTICS & TRACKING ============
        async function loadAnalyticsSettings() {
            try {
                const res = await fetch(`${API_BASE}?action=get-analytics-settings&token=${authToken}`);
                const data = await res.json();

                if (data.success && data.settings) {
                    const s = data.settings;

                    // GA4
                    if (s.ga4MeasurementId) {
                        document.getElementById('ga4MeasurementId').value = s.ga4MeasurementId;
                        document.getElementById('ga4-status').className = 'health-dot healthy';
                        document.getElementById('ga4-status-text').textContent = 'Connected';
                        document.getElementById('ga4StatsSection').style.display = 'block';
                    }

                    // Facebook Pixel
                    if (s.fbPixelId) {
                        document.getElementById('fbPixelId').value = s.fbPixelId;
                        document.getElementById('status-fbpixel').textContent = 'Active';
                        document.getElementById('status-fbpixel').className = 'status-badge connected';
                    }

                    // TikTok Pixel
                    if (s.tiktokPixelId) {
                        document.getElementById('tiktokPixelId').value = s.tiktokPixelId;
                        document.getElementById('status-tiktokpixel').textContent = 'Active';
                        document.getElementById('status-tiktokpixel').className = 'status-badge connected';
                    }

                    // Hotjar
                    if (s.hotjarSiteId) {
                        document.getElementById('hotjarSiteId').value = s.hotjarSiteId;
                        document.getElementById('status-hotjar').textContent = 'Active';
                        document.getElementById('status-hotjar').className = 'status-badge connected';
                    }

                    // Clarity
                    if (s.clarityProjectId) {
                        document.getElementById('clarityProjectId').value = s.clarityProjectId;
                        document.getElementById('status-clarity').textContent = 'Active';
                        document.getElementById('status-clarity').className = 'status-badge connected';
                    }
                }
            } catch (err) {
                console.error('Failed to load analytics settings:', err);
            }
        }

        document.getElementById('ga4SettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const measurementId = document.getElementById('ga4MeasurementId').value.trim();

            if (measurementId && !measurementId.startsWith('G-')) {
                showNotification('GA4 Measurement ID should start with G-', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}?action=save-analytics-settings&token=${authToken}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ga4MeasurementId: measurementId })
                });

                const data = await res.json();
                if (data.success) {
                    showNotification('GA4 settings saved!', 'success');
                    if (measurementId) {
                        document.getElementById('ga4-status').className = 'health-dot healthy';
                        document.getElementById('ga4-status-text').textContent = 'Connected';
                        document.getElementById('ga4StatsSection').style.display = 'block';
                    } else {
                        document.getElementById('ga4-status').className = 'health-dot';
                        document.getElementById('ga4-status-text').textContent = 'Not configured';
                        document.getElementById('ga4StatsSection').style.display = 'none';
                    }
                } else {
                    showNotification(data.error || 'Save failed', 'error');
                }
            } catch (err) {
                showNotification('Failed to save GA4 settings', 'error');
            }
        });

        async function saveAnalyticsIntegration(type) {
            let value, fieldId;

            switch(type) {
                case 'fbpixel':
                    fieldId = 'fbPixelId';
                    break;
                case 'tiktokpixel':
                    fieldId = 'tiktokPixelId';
                    break;
                case 'hotjar':
                    fieldId = 'hotjarSiteId';
                    break;
                case 'clarity':
                    fieldId = 'clarityProjectId';
                    break;
            }

            value = document.getElementById(fieldId).value.trim();

            try {
                const res = await fetch(`${API_BASE}?action=save-analytics-settings&token=${authToken}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [fieldId]: value })
                });

                const data = await res.json();
                if (data.success) {
                    showNotification(`${type} settings saved!`, 'success');
                    const statusEl = document.getElementById(`status-${type}`);
                    if (value) {
                        statusEl.textContent = 'Active';
                        statusEl.className = 'status-badge connected';
                    } else {
                        statusEl.textContent = 'Not Set';
                        statusEl.className = 'status-badge disconnected';
                    }
                } else {
                    showNotification(data.error || 'Save failed', 'error');
                }
            } catch (err) {
                showNotification('Failed to save settings', 'error');
            }
        }

        // ==================== CUSTOM ANALYTICS DASHBOARD ====================
        const ANALYTICS_API = '/api/analytics.php';
        let trafficChartData = null;
        let realtimeInterval = null;

        async function loadCustomAnalytics() {
            const days = parseInt(document.getElementById('analyticsDays').value) || 30;

            // Load all analytics data in parallel
            await Promise.all([
                loadAnalyticsDashboard(days),
                loadTrafficChart(days),
                loadTopPages(days),
                loadTrafficSources(days),
                loadDeviceBreakdown(days),
                loadBrowserBreakdown(days),
                loadCountryBreakdown(days),
                loadRecentEvents(),
                loadRealtimeVisitors()
            ]);
        }

        async function loadAnalyticsDashboard(days) {
            try {
                const res = await fetch(`${ANALYTICS_API}?action=dashboard&days=${days}&token=${authToken}`);
                const data = await res.json();

                if (data.success) {
                    const { today, period, realtime } = data;

                    // Update stats
                    document.getElementById('stat-visitors').textContent = formatNumber(period.visitors || 0);
                    document.getElementById('stat-sessions').textContent = formatNumber(period.sessions || 0);
                    document.getElementById('stat-pageviews').textContent = formatNumber(period.pageviews || 0);
                    document.getElementById('stat-avgduration').textContent = formatDuration(period.avgDuration || 0);
                    document.getElementById('stat-bounce').textContent = (period.bounceRate || 0).toFixed(1) + '%';
                    document.getElementById('realtimeCount').textContent = realtime || 0;
                }
            } catch (err) {
                console.error('Dashboard load error:', err);
            }
        }

        async function loadTrafficChart(days) {
            try {
                const res = await fetch(`${ANALYTICS_API}?action=traffic&days=${days}&token=${authToken}`);
                const data = await res.json();

                if (data.success) {
                    trafficChartData = data.data;
                    updateTrafficChart();
                }
            } catch (err) {
                console.error('Traffic chart error:', err);
            }
        }

        function updateTrafficChart() {
            if (!trafficChartData || trafficChartData.length === 0) {
                document.getElementById('trafficChartSvg').innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="#666">No data available</text>';
                return;
            }

            const svg = document.getElementById('trafficChartSvg');
            const container = document.getElementById('trafficChart');
            const width = container.clientWidth - 60;
            const height = 240;
            const padding = { top: 20, right: 20, bottom: 30, left: 50 };

            const showVisitors = document.getElementById('showVisitors').checked;
            const showPageviews = document.getElementById('showPageviews').checked;
            const showSessions = document.getElementById('showSessions').checked;

            // Calculate max value
            let maxVal = 0;
            trafficChartData.forEach(d => {
                if (showVisitors && d.visitors > maxVal) maxVal = d.visitors;
                if (showPageviews && d.pageviews > maxVal) maxVal = d.pageviews;
                if (showSessions && d.sessions > maxVal) maxVal = d.sessions;
            });
            maxVal = Math.max(maxVal, 10);

            const xScale = (i) => padding.left + (i / (trafficChartData.length - 1 || 1)) * (width - padding.left - padding.right);
            const yScale = (val) => height - padding.bottom - (val / maxVal) * (height - padding.top - padding.bottom);

            let svgContent = '';

            // Grid lines
            for (let i = 0; i <= 4; i++) {
                const y = padding.top + (i / 4) * (height - padding.top - padding.bottom);
                const val = Math.round(maxVal * (1 - i / 4));
                svgContent += `<line class="grid-line" x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}"/>`;
                svgContent += `<text x="${padding.left - 8}" y="${y + 4}" text-anchor="end">${formatNumber(val)}</text>`;
            }

            // X-axis labels
            const labelStep = Math.ceil(trafficChartData.length / 7);
            trafficChartData.forEach((d, i) => {
                if (i % labelStep === 0 || i === trafficChartData.length - 1) {
                    const x = xScale(i);
                    const date = new Date(d.date);
                    const label = `${date.getMonth() + 1}/${date.getDate()}`;
                    svgContent += `<text x="${x}" y="${height - 8}" text-anchor="middle">${label}</text>`;
                }
            });

            // Helper to create path
            const createPath = (key, color) => {
                let pathD = '';
                let areaD = '';
                trafficChartData.forEach((d, i) => {
                    const x = xScale(i);
                    const y = yScale(d[key] || 0);
                    pathD += (i === 0 ? 'M' : 'L') + `${x},${y}`;
                    areaD += (i === 0 ? 'M' : 'L') + `${x},${y}`;
                });
                areaD += `L${xScale(trafficChartData.length - 1)},${height - padding.bottom}L${xScale(0)},${height - padding.bottom}Z`;

                svgContent += `<path class="chart-area" d="${areaD}" fill="${color}"/>`;
                svgContent += `<path class="chart-line" d="${pathD}" stroke="${color}"/>`;

                // Data points
                trafficChartData.forEach((d, i) => {
                    const x = xScale(i);
                    const y = yScale(d[key] || 0);
                    svgContent += `<circle class="data-point" cx="${x}" cy="${y}" r="4" fill="${color}"
                        data-date="${d.date}" data-value="${d[key] || 0}" data-type="${key}"/>`;
                });
            };

            if (showVisitors) createPath('visitors', '#c19a6b');
            if (showPageviews) createPath('pageviews', '#60a5fa');
            if (showSessions) createPath('sessions', '#a78bfa');

            svg.innerHTML = svgContent;

            // Add tooltip interactivity
            svg.querySelectorAll('.data-point').forEach(point => {
                point.addEventListener('mouseenter', (e) => {
                    const rect = container.getBoundingClientRect();
                    const tooltip = document.createElement('div');
                    tooltip.className = 'chart-tooltip';
                    tooltip.innerHTML = `
                        <div style="font-weight: 600;">${e.target.dataset.date}</div>
                        <div style="color: var(--text-secondary);">${e.target.dataset.type}: ${formatNumber(parseInt(e.target.dataset.value))}</div>
                    `;
                    tooltip.style.left = `${e.clientX - rect.left + 10}px`;
                    tooltip.style.top = `${e.clientY - rect.top - 40}px`;
                    tooltip.id = 'chartTooltip';
                    container.appendChild(tooltip);
                });
                point.addEventListener('mouseleave', () => {
                    const tooltip = document.getElementById('chartTooltip');
                    if (tooltip) tooltip.remove();
                });
            });
        }

        async function loadTopPages(days) {
            try {
                const res = await fetch(`${ANALYTICS_API}?action=pages&days=${days}&limit=10&token=${authToken}`);
                const data = await res.json();
                const tbody = document.getElementById('topPagesBody');

                if (data.success && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(page => `
                        <tr>
                            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${escapeHtml(page.page_path)}">
                                ${escapeHtml(page.page_path)}
                            </td>
                            <td style="text-align: right;">${formatNumber(page.views)}</td>
                            <td style="text-align: right;">${formatNumber(page.unique_views)}</td>
                            <td style="text-align: right;">${formatDuration(page.avg_time)}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No page data yet</td></tr>';
                }
            } catch (err) {
                console.error('Top pages error:', err);
            }
        }

        async function loadTrafficSources(days) {
            try {
                const res = await fetch(`${ANALYTICS_API}?action=referrers&days=${days}&limit=10&token=${authToken}`);
                const data = await res.json();
                const tbody = document.getElementById('trafficSourcesBody');

                if (data.success && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(source => `
                        <tr>
                            <td>${escapeHtml(source.referrer_domain || 'Direct')}</td>
                            <td style="text-align: right;">${formatNumber(source.visitors)}</td>
                            <td style="text-align: right;">${formatNumber(source.sessions)}</td>
                            <td style="text-align: right;">${(source.bounce_rate || 0).toFixed(1)}%</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No referrer data yet</td></tr>';
                }
            } catch (err) {
                console.error('Traffic sources error:', err);
            }
        }

        async function loadDeviceBreakdown(days) {
            try {
                const res = await fetch(`${ANALYTICS_API}?action=devices&days=${days}&token=${authToken}`);
                const data = await res.json();

                if (data.success && data.data.length > 0) {
                    const total = data.data.reduce((sum, d) => sum + parseInt(d.count), 0);
                    const deviceMap = { desktop: 0, mobile: 0, tablet: 0 };

                    data.data.forEach(d => {
                        deviceMap[d.device_type] = parseInt(d.count);
                    });

                    ['desktop', 'mobile', 'tablet'].forEach(device => {
                        const pct = total > 0 ? (deviceMap[device] / total * 100) : 0;
                        document.getElementById(`device-${device}-pct`).textContent = pct.toFixed(1) + '%';
                        document.getElementById(`device-${device}-bar`).style.width = pct + '%';
                    });
                }
            } catch (err) {
                console.error('Device breakdown error:', err);
            }
        }

        async function loadBrowserBreakdown(days) {
            try {
                const res = await fetch(`${ANALYTICS_API}?action=devices&days=${days}&token=${authToken}`);
                const data = await res.json();
                const container = document.getElementById('browserBreakdown');

                if (data.success && data.browsers && data.browsers.length > 0) {
                    const total = data.browsers.reduce((sum, b) => sum + parseInt(b.count), 0);
                    const colors = ['#c19a6b', '#60a5fa', '#a78bfa', '#4ade80', '#f472b6'];

                    container.innerHTML = data.browsers.slice(0, 5).map((b, i) => {
                        const pct = total > 0 ? (parseInt(b.count) / total * 100) : 0;
                        return `
                            <div class="breakdown-item" style="margin-bottom: var(--space-sm);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span>${escapeHtml(b.browser)}</span>
                                    <span>${pct.toFixed(1)}%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${pct}%; background: ${colors[i]};"></div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<p style="color: var(--text-muted);">No browser data yet</p>';
                }
            } catch (err) {
                console.error('Browser breakdown error:', err);
            }
        }

        async function loadCountryBreakdown(days) {
            try {
                const res = await fetch(`${ANALYTICS_API}?action=countries&days=${days}&limit=5&token=${authToken}`);
                const data = await res.json();
                const container = document.getElementById('countryBreakdown');

                if (data.success && data.data.length > 0) {
                    const total = data.data.reduce((sum, c) => sum + parseInt(c.visitors), 0);
                    const countryFlags = {
                        'US': 'üá∫üá∏', 'CA': 'üá®üá¶', 'GB': 'üá¨üáß', 'AU': 'üá¶üá∫', 'DE': 'üá©üá™',
                        'FR': 'üá´üá∑', 'NL': 'üá≥üá±', 'BR': 'üáßüá∑', 'MX': 'üá≤üáΩ', 'ES': 'üá™üá∏',
                        'IT': 'üáÆüáπ', 'IN': 'üáÆüá≥', 'JP': 'üáØüáµ', 'KR': 'üá∞üá∑', 'CN': 'üá®üá≥'
                    };

                    container.innerHTML = data.data.map(c => {
                        const pct = total > 0 ? (parseInt(c.visitors) / total * 100) : 0;
                        const flag = countryFlags[c.country] || 'üåç';
                        return `
                            <div class="breakdown-item" style="margin-bottom: var(--space-sm);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span>${flag} ${escapeHtml(c.country || 'Unknown')}</span>
                                    <span>${formatNumber(c.visitors)} (${pct.toFixed(1)}%)</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${pct}%;"></div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<p style="color: var(--text-muted);">No country data yet</p>';
                }
            } catch (err) {
                console.error('Country breakdown error:', err);
            }
        }

        async function loadRecentEvents() {
            try {
                const res = await fetch(`${ANALYTICS_API}?action=events&limit=20&token=${authToken}`);
                const data = await res.json();
                const tbody = document.getElementById('recentEventsBody');

                if (data.success && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(event => `
                        <tr>
                            <td>${formatTimeAgo(event.created_at)}</td>
                            <td><span class="status status--pending">${escapeHtml(event.event_category)}</span></td>
                            <td>${escapeHtml(event.event_action)}</td>
                            <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;" title="${escapeHtml(event.event_label || '')}">
                                ${escapeHtml(event.event_label || '-')}
                            </td>
                            <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">
                                ${escapeHtml(event.page_url ? new URL(event.page_url).pathname : '-')}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No events recorded yet</td></tr>';
                }
            } catch (err) {
                console.error('Events error:', err);
            }
        }

        async function loadRealtimeVisitors() {
            try {
                const res = await fetch(`${ANALYTICS_API}?action=realtime&token=${authToken}`);
                const data = await res.json();

                if (data.success) {
                    document.getElementById('realtimeCount').textContent = data.count || 0;

                    const container = document.getElementById('realtimeVisitorsList');
                    if (data.visitors && data.visitors.length > 0) {
                        container.innerHTML = data.visitors.slice(0, 5).map(v => {
                            const pageName = v.current_page ? new URL(v.current_page).pathname : '/';
                            return `
                                <div class="realtime-visitor-pill">
                                    ${v.country || 'üåç'} <span class="page">${escapeHtml(pageName)}</span>
                                </div>
                            `;
                        }).join('');
                    } else {
                        container.innerHTML = '<span style="color: var(--text-muted); font-size: 0.85rem;">No active visitors</span>';
                    }
                }
            } catch (err) {
                console.error('Realtime error:', err);
            }
        }

        // Helper functions
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function formatDuration(seconds) {
            if (!seconds || seconds < 1) return '0s';
            if (seconds < 60) return Math.round(seconds) + 's';
            const mins = Math.floor(seconds / 60);
            const secs = Math.round(seconds % 60);
            return mins + 'm ' + secs + 's';
        }

        function formatTimeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return diffMins + 'm ago';
            if (diffMins < 1440) return Math.floor(diffMins / 60) + 'h ago';
            return Math.floor(diffMins / 1440) + 'd ago';
        }

        // Start real-time updates when on analytics panel
        function startRealtimeUpdates() {
            if (realtimeInterval) clearInterval(realtimeInterval);
            realtimeInterval = setInterval(loadRealtimeVisitors, 15000);
        }

        function stopRealtimeUpdates() {
            if (realtimeInterval) {
                clearInterval(realtimeInterval);
                realtimeInterval = null;
            }
        }

        // Hook into panel switching
        const originalShowPanel = window.showPanel || function() {};
        window.showPanel = function(panelName) {
            originalShowPanel(panelName);
            if (panelName === 'analytics') {
                loadCustomAnalytics();
                startRealtimeUpdates();
            } else {
                stopRealtimeUpdates();
            }
        };

        // Add SMTP, templates, and analytics to dashboard load
        // ==================== THEME EDITOR FUNCTIONS ====================

        let currentTheme = {
            colors: {},
            typography: {},
            background: {},
            effects: {}
        };
        let themePresets = [];

        // Load theme presets
        async function loadThemePresets() {
            try {
                const res = await fetch('/api/theme.php?action=presets');
                const data = await res.json();
                if (data.success) {
                    themePresets = data.presets;
                    renderThemePresets();
                }
            } catch (e) {
                console.error('Failed to load theme presets:', e);
            }
        }

        // Render preset cards
        function renderThemePresets() {
            const grid = document.getElementById('themePresetsGrid');
            if (!grid) return;

            grid.innerHTML = themePresets.map(preset => `
                <div class="theme-preset-card" onclick="applyPreset('${preset.id}')" data-preset="${preset.id}">
                    <div class="preset-colors">
                        <div class="preset-color" style="background: ${preset.colors.primary}"></div>
                        <div class="preset-color" style="background: ${preset.colors.secondary}"></div>
                        <div class="preset-color" style="background: ${preset.colors.accent}"></div>
                        <div class="preset-color" style="background: ${preset.colors.background}"></div>
                    </div>
                    <div class="preset-name">${preset.name}</div>
                    <div class="preset-desc">${preset.description || ''}</div>
                </div>
            `).join('');
        }

        // Apply a preset theme
        async function applyPreset(presetId) {
            try {
                const res = await fetch('/api/theme.php?action=apply-preset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken
                    },
                    body: JSON.stringify({ presetId })
                });
                const data = await res.json();
                if (data.success) {
                    currentTheme = data.theme;
                    updateThemeEditorUI();
                    showNotification('Preset applied!', 'success');

                    // Highlight active preset
                    document.querySelectorAll('.theme-preset-card').forEach(card => {
                        card.classList.remove('active');
                        if (card.dataset.preset === presetId) {
                            card.classList.add('active');
                        }
                    });
                }
            } catch (e) {
                showNotification('Failed to apply preset', 'error');
            }
        }

        // Load current theme
        async function loadTheme() {
            try {
                const res = await fetch('/api/theme.php?action=get');
                const data = await res.json();
                if (data.success) {
                    currentTheme = data.theme;
                    updateThemeEditorUI();
                }
            } catch (e) {
                console.error('Failed to load theme:', e);
            }
        }

        // Update all UI controls to match current theme
        function updateThemeEditorUI() {
            // Update color inputs
            if (currentTheme.colors) {
                Object.entries(currentTheme.colors).forEach(([key, value]) => {
                    const colorInput = document.getElementById('color-' + key);
                    const hexInput = colorInput?.nextElementSibling;
                    if (colorInput) {
                        colorInput.value = value;
                        if (hexInput) hexInput.value = value;
                    }
                });
            }

            // Update typography controls
            if (currentTheme.typography) {
                Object.entries(currentTheme.typography).forEach(([key, value]) => {
                    const el = document.getElementById('typo-' + key);
                    if (el) {
                        if (el.type === 'range') {
                            el.value = parseFloat(value);
                            const valueDisplay = document.getElementById('typo-' + key + '-value');
                            if (valueDisplay) valueDisplay.textContent = value;
                        } else {
                            el.value = value;
                        }
                    }
                });
                updateTypographyPreview();
            }

            // Update background controls
            if (currentTheme.background) {
                const bgType = document.getElementById('bg-type');
                const bgValue = document.getElementById('bg-value');
                const bgOverlay = document.getElementById('bg-overlay');
                const bgPattern = document.getElementById('bg-pattern');

                if (bgType) bgType.value = currentTheme.background.type || 'solid';
                if (bgValue) bgValue.value = currentTheme.background.value || '';
                if (bgOverlay) {
                    bgOverlay.value = currentTheme.background.overlay || 0.9;
                    const valueDisplay = document.getElementById('bg-overlay-value');
                    if (valueDisplay) valueDisplay.textContent = bgOverlay.value;
                }
                if (bgPattern) bgPattern.value = currentTheme.background.pattern || 'none';

                updateBackgroundPreview();
            }

            // Update effects controls
            if (currentTheme.effects) {
                const borderRadius = document.getElementById('effect-borderRadius');
                const cardShadow = document.getElementById('effect-cardShadow');
                const glowEffect = document.getElementById('effect-glowEffect');
                const animations = document.getElementById('effect-animations');

                if (borderRadius) {
                    borderRadius.value = parseInt(currentTheme.effects.borderRadius) || 12;
                    const valueDisplay = document.getElementById('effect-borderRadius-value');
                    if (valueDisplay) valueDisplay.textContent = borderRadius.value + 'px';
                }
                if (cardShadow) cardShadow.value = currentTheme.effects.cardShadow || 'md';
                if (glowEffect) glowEffect.checked = currentTheme.effects.glowEffect || false;
                if (animations) animations.checked = currentTheme.effects.animations !== false;
            }
        }

        // Update a single color in the theme
        function updateThemeColor(key, value) {
            currentTheme.colors = currentTheme.colors || {};
            currentTheme.colors[key] = value;

            // Sync hex input
            const hexInput = document.querySelector('#color-' + key)?.nextElementSibling;
            if (hexInput) hexInput.value = value;

            applyLivePreview();
        }

        // Update color from hex input
        function updateThemeColorHex(key, value) {
            if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
                currentTheme.colors = currentTheme.colors || {};
                currentTheme.colors[key] = value;

                const colorInput = document.getElementById('color-' + key);
                if (colorInput) colorInput.value = value;

                applyLivePreview();
            }
        }

        // Update typography setting
        function updateTypography(key, value) {
            currentTheme.typography = currentTheme.typography || {};
            currentTheme.typography[key] = value;

            // Update value display for range inputs
            const valueDisplay = document.getElementById('typo-' + key + '-value');
            if (valueDisplay) valueDisplay.textContent = value;

            updateTypographyPreview();
            applyLivePreview();
        }

        // Update typography preview
        function updateTypographyPreview() {
            const heading = document.getElementById('typo-preview-heading');
            const body = document.getElementById('typo-preview-body');

            if (heading && currentTheme.typography) {
                heading.style.fontFamily = currentTheme.typography.headingFont || 'inherit';
                heading.style.fontWeight = currentTheme.typography.headingWeight || '700';
                heading.style.letterSpacing = currentTheme.typography.headingLetterSpacing || '0.02em';
            }

            if (body && currentTheme.typography) {
                body.style.fontFamily = currentTheme.typography.bodyFont || 'inherit';
                body.style.fontWeight = currentTheme.typography.bodyWeight || '400';
                body.style.fontSize = currentTheme.typography.baseFontSize || '16px';
                body.style.lineHeight = currentTheme.typography.lineHeight || '1.6';
                body.style.letterSpacing = currentTheme.typography.letterSpacing || '0';
            }
        }

        // Update background setting
        function updateBackground(key, value) {
            currentTheme.background = currentTheme.background || {};
            currentTheme.background[key] = value;

            // Update value display for range inputs
            if (key === 'overlay') {
                const valueDisplay = document.getElementById('bg-overlay-value');
                if (valueDisplay) valueDisplay.textContent = value;
            }

            updateBackgroundPreview();
            applyLivePreview();
        }

        // Update background preview
        function updateBackgroundPreview() {
            const preview = document.getElementById('bg-preview');
            if (!preview || !currentTheme.background) return;

            const type = currentTheme.background.type || 'solid';
            const value = currentTheme.background.value || currentTheme.colors?.background || '#0A0A0A';

            if (type === 'solid') {
                preview.style.background = value;
            } else if (type === 'gradient') {
                preview.style.background = value;
            } else if (type === 'image') {
                preview.style.background = `url(${value}) center/cover`;
            }

            // Apply overlay
            const overlay = currentTheme.background.overlay || 0.9;
            preview.style.position = 'relative';
        }

        // Toggle background options based on type
        function toggleBackgroundOptions() {
            const type = document.getElementById('bg-type')?.value;
            const valueWrapper = document.getElementById('bg-value-wrapper');
            const valueInput = document.getElementById('bg-value');

            if (valueInput) {
                if (type === 'solid') {
                    valueInput.placeholder = 'Color (e.g., #0A0A0A)';
                } else if (type === 'gradient') {
                    valueInput.placeholder = 'Gradient CSS (e.g., linear-gradient(...))';
                } else if (type === 'image') {
                    valueInput.placeholder = 'Image URL';
                }
            }
        }

        // Update effect setting
        function updateEffect(key, value) {
            currentTheme.effects = currentTheme.effects || {};
            currentTheme.effects[key] = value;

            // Update value display for range inputs
            if (key === 'borderRadius') {
                const valueDisplay = document.getElementById('effect-borderRadius-value');
                if (valueDisplay) valueDisplay.textContent = value;
            }

            applyLivePreview();
        }

        // Apply live preview to the page
        function applyLivePreview() {
            const root = document.documentElement;

            if (currentTheme.colors) {
                if (currentTheme.colors.primary) root.style.setProperty('--whiskey', currentTheme.colors.primary);
                if (currentTheme.colors.secondary) root.style.setProperty('--rust', currentTheme.colors.secondary);
                if (currentTheme.colors.background) root.style.setProperty('--charcoal', currentTheme.colors.background);
                if (currentTheme.colors.surface) root.style.setProperty('--surface', currentTheme.colors.surface);
                if (currentTheme.colors.cardBg) root.style.setProperty('--card-bg', currentTheme.colors.cardBg);
                if (currentTheme.colors.textPrimary) root.style.setProperty('--text-primary', currentTheme.colors.textPrimary);
                if (currentTheme.colors.textSecondary) root.style.setProperty('--text-secondary', currentTheme.colors.textSecondary);
                if (currentTheme.colors.border) root.style.setProperty('--border-subtle', currentTheme.colors.border);
            }

            if (currentTheme.effects) {
                if (currentTheme.effects.borderRadius) {
                    root.style.setProperty('--radius-md', currentTheme.effects.borderRadius);
                    root.style.setProperty('--radius-lg', `calc(${currentTheme.effects.borderRadius} * 1.5)`);
                }
            }
        }

        // Save theme to server
        async function saveTheme() {
            try {
                const res = await fetch('/api/theme.php?action=save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken
                    },
                    body: JSON.stringify(currentTheme)
                });
                const data = await res.json();
                if (data.success) {
                    showNotification('Theme saved successfully!', 'success');
                } else {
                    showNotification(data.error || 'Failed to save theme', 'error');
                }
            } catch (e) {
                showNotification('Failed to save theme', 'error');
            }
        }

        // Save and publish theme (generates CSS file)
        async function saveAndPublishTheme() {
            try {
                // First save the theme
                await saveTheme();

                // Then generate CSS
                const res = await fetch('/api/theme.php?action=generate-css', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + authToken
                    }
                });
                const data = await res.json();
                if (data.success) {
                    showNotification('Theme published! CSS generated at ' + data.cssPath, 'success');
                }
            } catch (e) {
                showNotification('Failed to publish theme', 'error');
            }
        }

        // Reset theme to defaults
        async function resetTheme() {
            if (!confirm('Are you sure you want to reset the theme to defaults?')) return;

            try {
                const res = await fetch('/api/theme.php?action=reset', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + authToken
                    }
                });
                const data = await res.json();
                if (data.success) {
                    currentTheme = data.theme;
                    updateThemeEditorUI();
                    applyLivePreview();
                    showNotification('Theme reset to defaults', 'success');
                }
            } catch (e) {
                showNotification('Failed to reset theme', 'error');
            }
        }

        // Export theme as JSON
        async function exportTheme() {
            try {
                const res = await fetch('/api/theme.php?action=export');
                const data = await res.json();
                if (data.success) {
                    const blob = new Blob([JSON.stringify(data.theme, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'theme-export.json';
                    a.click();
                    URL.revokeObjectURL(url);
                    showNotification('Theme exported!', 'success');
                }
            } catch (e) {
                showNotification('Failed to export theme', 'error');
            }
        }

        // Import theme from JSON file
        async function importTheme(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const themeData = JSON.parse(text);

                const res = await fetch('/api/theme.php?action=import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken
                    },
                    body: JSON.stringify({ theme: themeData })
                });
                const data = await res.json();
                if (data.success) {
                    currentTheme = data.theme;
                    updateThemeEditorUI();
                    applyLivePreview();
                    showNotification('Theme imported successfully!', 'success');
                }
            } catch (e) {
                showNotification('Failed to import theme. Invalid file format.', 'error');
            }

            event.target.value = '';
        }

        // Preview theme on live site
        function previewTheme() {
            window.open('/?preview_theme=1', '_blank');
        }

        // Initialize theme editor when panel is shown
        function initThemeEditor() {
            loadThemePresets();
            loadTheme();
        }

        // ==================== END THEME EDITOR ====================

        async function loadAllDashboardData() {
            loadGallery();
            loadSettings();
            loadPricing();
            loadUsers();
            loadFeatured();
            loadSocialLinks();
            loadIntegrations();
            loadDashboardStats();
            loadSystemHealth();
            loadRequests();
            loadSubscribers();
            loadAnalytics();
            loadLoginLogs();
            loadSmtpSettings();
            loadEmailTemplates();
            loadAnalyticsSettings();
            loadCustomAnalytics();
            initThemeEditor();
        }

        // Load all data if logged in
        if (authToken) {
            loadAllDashboardData();
        }
    </script>
</body>
</html>
